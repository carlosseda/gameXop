<html lang="es"><head><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Usuarios</title><meta name="description" content="Panel de administración de usuarios"><script type="module">class FontLoader extends HTMLElement {
  constructor () {
    super()
    this.shadow = this.attachShadow({ mode: 'open' })
    this.font = this.getAttribute('font')

    const font = document.createElement('link')
    font.href = `https://fonts.googleapis.com/css2?family=Lato:${this.font}&display=swap`
    font.rel = 'stylesheet'
    document.head.appendChild(font)
  }
}

customElements.define('font-loader-component', FontLoader)
;class Header extends HTMLElement {
  constructor () {
    super()
    this.shadow = this.attachShadow({ mode: 'open' })
  }

  connectedCallback () {
    this.render()
  }

  render () {
    this.shadow.innerHTML =
      /* html */`
      <style>
        header{
          align-items: center;
          background-color: hsla(0, 0%, 0%);
          box-sizing: border-box;
          display: flex;
          justify-content: space-between;
          min-height: 5vh;
          padding: 0.5rem 2rem;
        }
      </style>
      <header>
        <slot></slot>
      </header>
    `
  }
}

customElements.define('header-component', Header)
;class Main extends HTMLElement {
  constructor () {
    super()
    this.shadow = this.attachShadow({ mode: 'open' })
  }

  connectedCallback () {
    this.render()
  }

  render () {
    this.shadow.innerHTML =
      /* html */`
        <style>
          main{
            display: flex;
            flex-direction: column;
            gap: 2rem;
            height: 100%;
            padding: 2rem;
          }
        </style>
        <main>
          <slot></slot>
        </main>
      `
  }
}

customElements.define('main-component', Main)
;class Row extends HTMLElement {
  constructor () {
    super()
    this.shadow = this.attachShadow({ mode: 'open' })
    this.columns = this.getAttribute('columns') || 1
    this.gap = this.getAttribute('gap') || '1rem'
  }

  connectedCallback () {
    this.render()
  }

  render () {
    this.shadow.innerHTML =
      /* html */`
        <style>
          .row{
            display: grid;
            gap: ${this.gap};
            grid-template-columns: repeat(${this.columns}, 1fr);
          }
        </style>
        <div class="row">
          <slot></slot>
        </div>
      `
  }
}

customElements.define('row-component', Row)
;class Logo extends HTMLElement {
  constructor () {
    super()
    this.shadow = this.attachShadow({ mode: 'open' })
  }

  static get observedAttributes () {}

  connectedCallback () {
    this.render()
  }

  attributeChangedCallback (name, oldValue, newValue) {}

  render () {
    this.shadow.innerHTML =
      `
      <style>
          h2 {   
              color: hsl(0, 0%, 100%);
              font-family: 'Roboto', sans-serif;
              font-size: 2em;
              font-weight: 600;
              margin: 0;
              text-decoration: none;
          }
      </style>

      <h2>${this.getAttribute('title')}</h2>
      `
  }
}

customElements.define('logo-component', Logo)
;class Menu extends HTMLElement {
  constructor () {
    super()
    this.shadow = this.attachShadow({ mode: 'open' })
    this.menuItems = []
  }

  connectedCallback () {
    this.loadData().then(() => this.render())
  }

  async loadData () {
    const url = `${import.meta.env.VITE_API_URL}/admin/menus/display/${this.getAttribute('menu')}`

    try {
      const response = await fetch(url)
      const data = await response.json()
      this.menuItems = Object.values(data)
    } catch (error) {
      console.log(error)
    }
  }

  render () {
    this.shadow.innerHTML =
      /* html */`
        <style>
          .menu-container{
            position: relative;
          }

          #menu-button{
            align-items: center;
            border-radius: 50%;
            cursor:pointer;
            display: flex;
            height: 2.7rem;
            justify-content: center;
            position: relative;
            width: 2.7em;
            z-index: 3001;
          }
          
          #menu-button:hover{
            background-color: hsl(272 40% 35%);
          }

          #menu-button.active{
            background-color: hsl(272 40% 35%);
          }

          #menu-button svg{
            fill: hsl(0, 0%, 100%);
            height: 2rem;
            width: 2rem;
          }

          #menu{
            background-color: hsl(0, 0%, 0%);
            border: 0.5rem solid hsl(0, 0%, 100%);
            height: 50vh;
            right: -3rem;
            position: absolute;
            transition: opacity 0.3s;
            top: 4rem;
            opacity: 0;
            padding: 5%;
            visibility: hidden;
            width: 400px;
            z-index: -1;
          }

          #menu.active{
            opacity: 1;
            visibility: visible;
            z-index: 6000;
          }

          nav {
            display: flex;
            align-items: center;
            justify-content: left;
          }
            
          nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column; 
          }
            
          nav ul li {
            position: relative;
            width: max-content;
          }
            
          nav ul li a {
            display: block;
            font-family: 'Roboto', sans-serif;
            font-size: 1.5em;
            padding: 0.5rem;
            text-decoration: none;
            color: hsl(207, 85%, 69%);
          }

          nav ul li a:hover {
            color: hsl(19, 100%, 50%);
          }

          nav ul li .sub-menu {
            display: none;
          }
          
          nav ul li:hover .sub-menu {
            display: block;
          }
            
          nav ul li:hover > .sub-menu {
            visibility: visible;
            animation: slide-in 0.5s ease-in-out; /* animación de apertura */
          }
            
          .sub-menu {
            position: absolute;
            top: 0;
            left: 100%; 
            visibility: hidden;
            animation: slide-out 0.5s ease-in-out;
          }
        </style>

        <div class="menu-container">
          <div id="menu-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16,20H20V16H16M16,14H20V10H16M10,8H14V4H10M16,8H20V4H16M10,14H14V10H10M4,14H8V10H4M4,20H8V16H4M10,20H14V16H10M4,8H8V4H4V8Z" /></svg>
          </div>

          <div id="menu">
              <nav>
                  <ul>
                
                  </ul>
              </nav>
          </div>
        </div>
        `

    const menuList = this.shadow.querySelector('ul')

    this.menuItems.forEach(menuItem => {
      const li = document.createElement('li')
      const link = document.createElement('a')

      if (menuItem.localeSeo.url) { link.setAttribute('href', `${menuItem.localeSeo.url}`) }

      if (menuItem.customUrl) { link.setAttribute('href', `${menuItem.customUrl}`) }

      link.textContent = menuItem.name

      li.appendChild(link)

      this.createSubMenu(menuItem, li)

      menuList.appendChild(li)
    })

    this.shadow.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', (event) => {
        event.preventDefault()

        menuButton.classList.toggle('active')
        menu.classList.toggle('active')

        document.dispatchEvent(new CustomEvent('newUrl', {
          detail: {
            url: link.getAttribute('href'),
            title: link.textContent
          }
        }))
      })
    })

    const menuButton = this.shadow.querySelector('#menu-button')
    const menu = this.shadow.querySelector('#menu')

    menuButton.addEventListener('click', (event) => {
      menuButton.classList.toggle('active')
      menu.classList.toggle('active')
    })
  }

  createSubMenu (menuItem, li) {
    if (menuItem.children) {
      const subMenu = document.createElement('ul')
      subMenu.classList.add('sub-menu')
      li.append(subMenu)

      Object.values(menuItem.children).forEach(subMenuItem => {
        const subLi = document.createElement('li')
        const subLink = document.createElement('a')

        subLink.setAttribute('href', subMenuItem.customUrl)
        subLink.textContent = subMenuItem.name

        subLi.appendChild(subLink)
        subMenu.appendChild(subLi)

        this.createSubMenu(subMenuItem, subLi)
      })

      li.appendChild(subMenu)
    }
  }
}

customElements.define('menu-component', Menu)
;class UserArea extends HTMLElement {
  constructor () {
    super()
    this.shadow = this.attachShadow({ mode: 'open' })
    this.user = []
  }

  connectedCallback () {
    this.loadData().then(() => this.render())
  }

  async loadData () {
    const url = `${import.meta.env.VITE_API_URL}/api/admin/users/user-area`

    try {
      const response = await fetch(url)
      this.user = await response.json()
    } catch (error) {
      console.log(error)
    }
  }

  render () {
    this.shadow.innerHTML =
      /* html */`
        <style>
          h4 {   
            color: hsl(0, 0%, 100%);
            font-family: 'Lato', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
            text-decoration: none;
            text-align:center;
          }

          .user-area {
            align-items: center;
            display: flex;
            gap: 1rem;
            justify-content: center;
          }

          .user-avatar {
            align-items: center;
            background-color: hsl(272 40% 35%);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            height: 2.7rem;
            overflow: hidden;
            width: 2.7rem;
          }

          .user-avatar svg {
            fill: hsl(0, 0%, 100%);
            height: 30px;
            width: 30px;
          }

          .user-avatar img {
            object-fit: cover;
            width: 100%;
          }
        </style>

        <div class="user-area">
          <div class="user-avatar">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" /></svg>
          </div>
        </div>
      `

    if (this.user.images.avatar?.resizedFilename) {
      const image = document.createElement('img')
      image.src = `${import.meta.env.VITE_API_URL}/api/admin/image-gallery/image/${this.user.images.avatar.resizedFilename}`
      image.alt = this.user.images.avatar.alt
      image.title = this.user.images.avatar.title
      this.shadow.querySelector('.user-avatar').innerHTML = ''
      this.shadow.querySelector('.user-avatar').appendChild(image)
    }
  }
}

customElements.define('user-area-component', UserArea)
;import { store } from '../redux/store.js'
import { showFormElement, refreshTable } from '../redux/crud-slice.js'

class DeleteElementModal extends HTMLElement {
  constructor () {
    super()
    this.shadow = this.attachShadow({ mode: 'open' })
  }

  connectedCallback () {
    document.addEventListener('showDeleteModal', this.handleShowDeleteModal.bind(this))
    this.render()
  }

  handleShowDeleteModal (event) {
    this.element = event.detail.element
    this.endPoint = event.detail.endPoint
    this.shadow.querySelector('.overlayer').classList.add('active')
  }

  render () {
    this.shadow.innerHTML =
      /* html */`
      <style>
          .overlayer {
            align-items: center;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            height: 100vh;
            justify-content: center;
            left: 0;
            opacity: 0;
            position: fixed;
            top: 0;
            transition: opacity 0.3s;
            visibility: hidden;
            width: 100%;
            z-index: -1;
          }

          .overlayer.active {
            opacity: 1;
            visibility: visible;
            z-index: 1000;
          }

          .modal-delete{
            background-color: hsl(0, 0%, 100%);
            position: absolute;
            width: 500px;
          }
          
          .modal-delete-header{
              background-color: $grey;
              border-bottom: 1px solid #e9ecef;
              padding: 0.5em 1em;
              text-align: center;
          }

          .modal-delete-header h4{
              font-size: 1.2em;
              font-family: 'Roboto', sans-serif;
              margin: 0;
          }
          
          .modal-delete-footer{
              display: flex;
          }

          .modal-delete-option{
              color: hsl(0, 0%, 100%);
              cursor: pointer;
              font-weight: 600;
              font-family: 'Roboto', sans-serif;
              text-align: center;
              width: 50%;
          }

          .modal-delete-option:hover{
            filter: brightness(1.2);
          }

          .modal-delete-option#delete-cancel{
              background-color: hsl(183, 98%, 35%);;
          }

          .modal-delete-option#delete-confirm{
              background-color: hsl(0, 65%, 55%);
          }
      </style>

      <div class="overlayer">
        <div class="modal-delete">
          <div class="modal-delete-content">
              <div class="modal-delete-header">
                  <h4>¿Quiere eliminar este registro?</h4>
              </div>

              <div class="modal-delete-footer">
                <div class="modal-delete-option" id="delete-confirm">
                  <h4>Sí</h4>
                </div>
                <div class="modal-delete-option " id="delete-cancel">
                  <h4>No</h4>
                </div>
              </div>
            </div>
        </div>
      </div>
      `

    this.shadow.querySelector('#delete-confirm').addEventListener('click', () => {
      fetch(this.element, {
        method: 'DELETE'
      }).then(response => {
        return response.json()
      }).then(data => {
        store.dispatch(showFormElement({
          endPoint: this.endPoint,
          data: null
        }))

        store.dispatch(refreshTable(this.endPoint))

        document.dispatchEvent(new CustomEvent('message', {
          detail: {
            message: data.message,
            type: 'success'
          }
        }))

        this.shadow.querySelector('.overlayer').classList.remove('active')
      }).catch(error => {
        document.dispatchEvent(new CustomEvent('message', {
          detail: {
            message: error.message,
            type: 'error'
          }
        }))
      })
    })

    this.shadow.querySelector('#delete-cancel').addEventListener('click', () => {
      this.shadow.querySelector('.overlayer').classList.remove('active')
    })
  }
}

customElements.define('delete-element-modal-component', DeleteElementModal)
;import { store } from '../redux/store.js'
import { showImage, removeImage } from '../redux/images-slice.js'

class ImageGallery extends HTMLElement {
  constructor () {
    super()
    this.shadow = this.attachShadow({ mode: 'open' })
    this.unsubscribe = null
    this.image = {}
  }

  connectedCallback () {
    document.addEventListener('openGallery', this.handleOpenGallery.bind(this))
    this.render()
  }

  disconnectedCallback () {
    this.unsubscribe && this.unsubscribe()
  }

  handleOpenGallery (event) {
    this.openGallery()
  }

  handleShowElementGallery (event) {
    this.showElementGallery(event.detail.image)
  }

  async render () {
    this.shadow.innerHTML =
      /* html */`
        <style>
          .overlayer {
            align-items: center;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            height: 100vh;
            justify-content: center;
            left: 0;
            opacity: 0;
            position: fixed;
            top: 0;
            transition: opacity 0.3s;
            visibility: hidden;
            width: 100%;
            z-index: -1;
          }

          .overlayer.active {
            opacity: 1;
            visibility: visible;
            z-index: 5000;
          }

          .modal {
            height: 80%;
            position: absolute;
            width: 80%;
          }

          .modal-content {
            background-color: white;
            border: 1px solid #888;
            border-radius: 5px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            position: relative;
            width: 100%;
          }

          .modal-header {
            align-items: center;
            display: flex;
            height: 5%;
            justify-content: space-between;
            padding: 1%;
            width: 98%;
          }

          .modal-header h2 {
            font-family: 'Lato', sans-serif;
            margin: 0;
          }

          .modal-header .close {
            color: hsl(0, 0%, 40%);
            float: right;
            font-size: 2rem;
            font-weight: bold;
          }

          .modal-header .close:hover,
          .modal-header .close:focus {
            color: hsl(0, 0%, 20%);
            text-decoration: none;
            cursor: pointer;
          }

          .modal-body {
            border-bottom: 1px solid hsl(0, 0%, 90%);
            border-top: 1px solid hsl(0, 0%, 90%);
            display: flex;
            height: 85%;
          }

          .image-gallery {
            align-content: flex-start;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            height: 96%;
            overflow: scroll;
            overscroll-behavior-y: contain;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1%;
            width: 80%;
          }

          .image-gallery-loader {
            background-color: hsl(0, 0%, 90%);
            border-left: 1px solid hsl(0, 0%, 80%);
            height: 100%;
            overflow: scroll;
            overscroll-behavior-y: contain;
            overflow-y: auto;
            overflow-x: hidden;
            width: 20%;
          }

          .upload-image {
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            cursor: pointer;
            height: 135px;
            margin: 5px;
            overflow: hidden;
            padding: 5px;
            position: relative;
            width: 135px;
          }

          .upload-image input[type="file"] {
            display: none;
          }

          .upload-image label {
            align-items: center;  
            background-color: hsl(207, 85%, 69%);
            border: none;
            box-sizing: border-box;
            color: white;
            cursor: pointer;
            display: flex;
            font-family: 'Lato', sans-serif;
            font-size: 16px;
            height: 100%;
            justify-content: center;
            text-align: center;
            text-decoration: none;
            transition-duration: 0.4s;
            width: 100%;
          }

          .upload-image label:hover {
            filter: brightness(1.2);
          }

          .upload-image label svg {
            fill: white;
            height: 4em;
            width: 4rem;
          }

          .image-gallery .image {
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            cursor: pointer;
            height: 135px;
            margin: 5px;
            overflow: hidden;
            padding: 5px;
            position: relative;
            width: 135px;
          }

          .image-gallery .image:hover {
            border: 1px solid #aaa;
          }

          .image-gallery .image img {
            background-color: hsl(0, 0%, 0%);
            height: 100%;
            width: 100%;
          }

          .image-gallery .image.selected {
            border: 0.2rem solid #4CAF50;
          }

          .image-gallery-information{
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 1.5rem 1rem;
          }

          .image-gallery-loader-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
          }

          .image-gallery-loader-form label {
            color: hsl(0, 0%, 40%);
            font-family: 'Lato', sans-serif;
          }   

          .image-gallery-loader-form input {
            border: none;
            border-bottom: 1px solid hsl(0, 0%, 80%);
            box-sizing: border-box;
            font-family: 'Lato', sans-serif;
            height: 2rem;
            outline: none;  
            padding: 0.5rem;
            width: 100%;
          }

          .modal-footer {
            align-items: center;
            display: flex;
            justify-content: flex-end;
            padding: 1rem;
          }

          .modal-footer button {
            background-color: hsl(0, 0%, 90%);
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 16px;
            padding: 12px 24px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            transition-duration: 0.4s;
          }

          .modal-footer button.active {
            background-color: hsl(236 55% 25%);
            cursor: pointer;
          }

          .modal-footer button.active:hover {
            background-color: hsl(272 40% 35%);
          }
        </style>

        <div class="overlayer">
          <div class="modal">
            <div class="modal-content">
              <div class="modal-header">
                <h2>Galería</h2>
                <span class="close">&times;</span>
              </div>
              <div class="modal-body">
                <div class="image-gallery"></div>
                <div class="image-gallery-loader">
                  <div class="image-gallery-information">
                    <div class="image-gallery-loader-form">
                      <label for="title">Título</label>
                      <input type="text" name="title" />
                    </div>
                    <div class="image-gallery-loader-form">
                      <label for="description">Texto alternativo</label>
                      <input type="text" name="alt" />
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-primary">Elegir imagen</button>
              </div>
            </div>
          </div>
        </div>
        `

    await this.getThumbnails()

    this.shadow.querySelector('.overlayer').addEventListener('click', (event) => {
      if (event.target.closest('.close')) {
        this.closeGallery()
      }

      if (event.target.closest('.tabs-container-menu li')) {
        this.changeTab(event.target.closest('.tabs-container-menu li'))
      }

      if (event.target.closest('.image')) {
        this.selectImage(event.target.closest('.image'))
      }

      if (event.target.closest('.modal-footer button')) {
        if (event.target.classList.contains('active')) {
          this.createThumbnail()
        }
      }
    })

    this.shadow.querySelector('input[type="file"]').addEventListener('change', async event => {
      this.uploadImage(event.target.files[0])
    })
  }

  async openGallery () {
    const image = store.getState().images.imageGallery

    this.shadow.querySelector('.overlayer').classList.add('active')
    this.shadow.querySelector('input[name="title"]').value = image.title || ''
    this.shadow.querySelector('input[name="alt"]').value = image.alt || ''

    const imageElement = this.shadow.querySelector(`.image[data-filename="${image.filename}"]`)

    if (imageElement) {
      imageElement.classList.add('selected')
      this.shadow.querySelector('.modal-footer button').classList.add('active')
    }
  }

  async changeTab (tab) {
    this.shadow.querySelectorAll('.tabs-container-menu li').forEach(item => {
      item.classList.remove('active')
    })

    tab.classList.add('active')

    this.shadow.querySelectorAll('.tabs-container-content .tab').forEach((item) => {
      item.classList.remove('active')
    })

    this.shadow.querySelector(`.tabs-container-content .tab#${tab.id}`).classList.add('active')
  }

  async getThumbnails () {
    try {
      const imageGallery = this.shadow.querySelector('.image-gallery')
      imageGallery.innerHTML = ''
      const result = await fetch(`${import.meta.env.VITE_API_URL}/api/admin/image-gallery`)
      const data = await result.json()

      const uploadImage = document.createElement('div')
      const label = document.createElement('label')
      const input = document.createElement('input')

      uploadImage.classList.add('upload-image')
      label.setAttribute('for', 'file')
      input.setAttribute('type', 'file')
      input.setAttribute('id', 'file')
      input.setAttribute('name', 'file')
      input.setAttribute('accept', 'image/*')

      label.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z" /></svg>'

      uploadImage.appendChild(label)
      uploadImage.appendChild(input)

      imageGallery.appendChild(uploadImage)

      data.filenames.forEach(filename => {
        const imageContainer = document.createElement('div')
        const image = document.createElement('img')

        imageContainer.classList.add('image')
        imageContainer.setAttribute('data-filename', filename)
        image.src = `${import.meta.env.VITE_API_URL}/api/admin/image-gallery/${filename}`

        imageContainer.appendChild(image)
        imageGallery.appendChild(imageContainer)
      })
    } catch (e) {
      console.log(e)
    }
  }

  async uploadImage (file) {
    const formData = new FormData()
    formData.append('file', file)

    const result = await fetch(`${import.meta.env.VITE_API_URL}/api/admin/image-gallery`, {
      method: 'POST',
      body: formData
    })

    const filenames = await result.json()

    this.shadow.querySelectorAll('.image').forEach((item) => {
      item.classList.remove('selected')
    })

    filenames.forEach(filename => {
      const imageContainer = document.createElement('div')
      const image = document.createElement('img')

      imageContainer.classList.add('image', 'selected')
      imageContainer.setAttribute('data-filename', filename)
      image.src = `${import.meta.env.VITE_API_URL}/api/admin/image-gallery/${filename}`

      imageContainer.addEventListener('click', () => {
        this.shadow.querySelectorAll('.image').forEach(item => {
          item.classList.remove('selected')
        })

        imageContainer.classList.add('selected')
      })

      imageContainer.appendChild(image)

      const uploadImage = this.shadow.querySelector('.upload-image')
      uploadImage.insertAdjacentElement('afterend', imageContainer)
    })

    this.shadow.querySelector('.modal-footer button').classList.add('active')

    this.shadow.querySelector('input[name="alt"]').value = ''
    this.shadow.querySelector('input[name="title"]').value = ''
  }

  async selectImage (image) {
    this.shadow.querySelectorAll('.image').forEach(item => {
      item.classList.remove('selected')
    })

    image.classList.add('selected')

    this.shadow.querySelector('.modal-footer button').classList.add('active')
  }

  async createThumbnail () {
    let image = store.getState().images.imageGallery
    const alt = this.shadow.querySelector('input[name="alt"]').value
    const title = this.shadow.querySelector('input[name="title"]').value
    const filename = this.shadow.querySelector('.image.selected').getAttribute('data-filename')
    image = { ...image, alt, title, filename }

    if (store.getState().images.imageGallery.filename) {
      store.dispatch(removeImage(store.getState().images.imageGallery))
    }

    store.dispatch(showImage(image))

    this.closeGallery()
  }

  async closeGallery () {
    this.shadow.querySelector('.modal-footer button').classList.remove('active')

    this.shadow.querySelectorAll('.image').forEach(item => {
      item.classList.remove('selected')
    })

    this.shadow.querySelector('.overlayer').classList.remove('active')
  }
}

customElements.define('image-gallery-component', ImageGallery)
;class Message extends HTMLElement {
  constructor () {
    super()
    this.shadow = this.attachShadow({ mode: 'open' })
  }

  static get observedAttributes () { return ['message', 'type'] }

  connectedCallback () {
    document.addEventListener('message', this.handleMessage.bind(this))
    this.render()
  }

  attributeChangedCallback (name, oldValue, newValue) {
    if (name === 'message') {
      const message = this.shadow.querySelector('#alert-message')
      message.classList.add('active')

      this.shadow.querySelector('p').textContent = newValue

      setTimeout(function () {
        message.classList.remove('active')
      }, 7000)
    }

    if (name === 'type') {
      const message = this.shadow.querySelector('#alert-message')
      message.classList.add(newValue)
    }
  }

  handleMessage (event) {
    this.setAttribute('message', event.detail.message)
    this.setAttribute('type', event.detail.type)
  }

  render () {
    this.shadow.innerHTML =
        `
        <style>
            #alert-message{
                background-color: hsl(0, 0%, 100%);
                bottom: 3vh;
                opacity: 0;
                padding: 0 1em;
                position: fixed;
                transition: opacity 0.3s;
                right: 2rem;
                width: max-content;
                z-index: -1;
            }

            #alert-message.success{
                border-bottom: 0.2em solid hsl(207, 85%, 69%);
            }

            #alert-message.error{
                border-bottom: 0.2em solid hsl(0, 100%, 50%);
            }

            #alert-message.active{
                opacity: 1;
                z-index: 1;
            }

            p{
                font-family: 'Lato', sans-serif;
                font-size: 1.2em;
            }
        </style>

        <div id="alert-message">
            <p></p>
            <div id="alert-color"></div>
        </div>`
  }
}

customElements.define('message-component', Message)
;class Crud extends HTMLElement {
  constructor () {
    super()
    this.shadow = this.attachShadow({ mode: 'open' })
  }

  connectedCallback () {
    this.render()
  }

  render () {
    this.shadow.innerHTML =
      /* html */`
      <style>
        .crud {
          display: flex;
          justify-content: space-between;
          gap: 2rem;
          margin: 0 auto;
          width: 100%;
        }
        
        .crud-table {
          flex: 1;
        }
        
        .crud-form {
          flex: 2;
        }
      </style>

      <div class="crud">
        <div class="crud-table">
          <slot name="filter"></slot>
          <slot name="table"></slot>
        </div>

        <div class="crud-form">
          <slot name="form"></slot>
        </div>
      </div> 
    `
  }
}

customElements.define('crud-component', Crud)
;class TableFilter extends HTMLElement {
  constructor () {
    super()
    this.shadow = this.attachShadow({ mode: 'open' })
  }

  connectedCallback () {
    this.render()
  }

  render () {
    this.shadow.innerHTML =
      `
      <style>
        .table-filter{
          height: max-content;
          margin-bottom: 2em;
          position: relative;
          width: 100%;
        }

        .table-filter.active .table-filter-container{
          max-height: 70vh;
        }

        .table-filter-container{
          max-height: 0;
          margin: 0 auto;
          overflow: hidden;
          transition: max-height 0.5s;
          width: 100%;
        }

        .table-filter-container form{
          background-color: transparent;
        }

        .table-filter-buttons{
          width: 100%;
        }

        .table-filter-buttons .table-filter-button{
          cursor: pointer;
          max-height: 0;
          overflow: hidden;
          transition: max-height 0.5s;
          width: 100%;
          text-align: center;
        }

        .table-filter-buttons .table-filter-button:hover{
          svg path{
              fill: hsl(19, 100%, 50%);
          }
        }

        .table-filter-buttons .table-filter-button.active{
          max-height: 2.5rem;
        }

        .table-filter-buttons .table-filter-button.open-filter{
          background-color: hsl(0, 0%, 100%);
        }

        .table-filter-buttons .table-filter-button.apply-filter{
          background-color: hsl(160, 51%, 33%);
        }

        .table-filter-buttons .table-filter-button svg{
          height: 1.5em;
          padding: 0.5em;
          width: 1.5em;
        }

        .table-filter-buttons .table-filter-button.open-filter svg path{
          fill: hsl(207, 85%, 69%);
        }

        .table-filter-buttons .table-filter-button.open-filter svg:hover path{
          fill: hsl(19, 100%, 50%);
        }

        .table-filter-buttons .table-filter-button.apply-filter svg path{
          fill: hsl(0, 0%, 100%);
        }

        .table-filter-buttons .table-filter-button.apply-filter svg:hover path{
          fill: hsl(19, 100%, 50%);
        }

        .tabs-container-menu{
          background-color: hsl(100, 100%, 100%);
          display: flex;
          height: 2.5em;
          justify-content: space-between;
          width: 100%;
        }
        
        .tabs-container-menu ul{
          height: 2.5em;
          display: flex;
          margin: 0;
          padding: 0;
        }
        
        .tabs-container-menu li{
            color: hsl(0, 0%, 50%);
            cursor: pointer;
            font-family: 'Roboto' , sans-serif;
            list-style: none;
            font-weight: 600;
            padding: 0.5em;
            text-align: center;
        }
        
        .tabs-container-menu li.active,
        .tabs-container-menu li.active:hover{
            background-color:hsl(207, 85%, 69%);
            color: white;
        }
        
        .tabs-container-buttons{
            display: flex;
            padding: 0 0.5em;
        }

        .tabs-container-buttons svg{
            cursor: pointer;
            height: 2.5rem;
            width: 2.5rem;
            fill: hsl(207, 85%, 69%);
        }

        .tabs-container-buttons svg:hover{
            fill: hsl(19, 100%, 50%);
        }

        .errors-container{
            background-color: hsl(0, 0%, 100%);
            display: none;
            flex-direction: column;
            gap: 1em;
            margin-top: 1em;
            padding: 1em;
        }

        .errors-container.active{
            display: flex;
        }

        .errors-container .error-container{
            width: 100%;
        }

        .errors-container .error-container span{
            color: hsl(0, 0%, 50%);
            font-family: 'Ubuntu';
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .tab-panel{
            display: none;
        }
        
        .tab-panel.active{
            display: block;
            padding: 0.5em 0;
        }
        
        .row {
            display: flex;
            justify-content: space-between;
            gap: 2em;
        }

        .form-element{
            margin: 1em 0;
            width: 100%;
        }
        
        .form-element-label{
            display: flex;
            justify-content: space-between;
            margin-bottom: 1em;
            width: 100%;
        }
        
        .form-element-label label,
        .form-element-label span{
            color: hsl(0, 0%, 100%);
            font-family: 'Roboto', sans-serif;
            font-weight: 600;
            font-size: 1em;
            transition: color 0.5s;
        }

        .form-element-label label.invalid{
            color: hsl(351deg 88% 64%);
        }

        .form-element-label,
        .form-element-input{
            width: 100%;
        }

        input[type="submit"]{
            background: none;
            color: inherit;
            border: none;
            padding: 0;
            font: inherit;
            cursor: pointer;
            outline: inherit;
        }
        
        .form-element-input input, 
        .form-element-input textarea,
        .form-element-input select {
            background-color:hsl(226deg 64% 66%);
            border: none;
            border-bottom: 0.1em solid  hsl(0, 0%, 100%);
            box-sizing: border-box;
            color: hsl(0, 0%, 100%);
            font-family: 'Roboto', sans-serif;
            font-weight: 600;
            padding: 0.5em;
            width: 100%;
        }

        .form-element-input input:focus,
        .form-element-input textarea:focus,
        .form-element-input select:focus{
            outline: none;
            border-bottom: 0.1em solid hsl(207, 85%, 69%);
        }

        .form-element-input input.invalid,
        .form-element-input textarea.invalid{
            border-bottom: 0.1em solid hsl(0, 100%, 50%);
        }

        .form-element-input textarea{
            height: 10em;
        }

        .form-element-input .checkbox-container,
        .form-element-input .radio-container{
            display: flex;
            align-items: center;
            gap: 0.5em;
        }

        .form-element-input .checkbox-container input,
        .form-element-input .radio-container input{
            width: 1em;
            height: 1em;
        }

        .form-element-input .checkbox-container label,
        .form-element-input .radio-container label{
            color: hsl(0, 0%, 100%);
            font-family: 'Roboto', sans-serif;
            font-weight: 600;
            font-size: 1em;
        }

        .form-element-input .range-container{
            display: flex;
            align-items: center;
            gap: 0.5em;
        }

        .form-element-input .range-container input{
            width: 100%;
        }

        .form-element-input .range-container label{
            color: hsl(0, 0%, 100%);
            font-family: 'Roboto', sans-serif;
            font-weight: 600;
            font-size: 1em;
        }

        .form-element-input .range-container .range-value{
            color: hsl(0, 0%, 100%);
            font-family: 'Roboto', sans-serif;
            font-weight: 600;
            font-size: 1em;
        }

        .form-element-input .range-container input[type="range"]{
            -webkit-appearance: none;
            width: 100%;
            height: 0.5em;
            border-radius: 0.5em;
            background: hsl(0, 0%, 100%);
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }

        .form-element-input input[type="time"]::-webkit-calendar-picker-indicator,
        .form-element-input input[type="date"]::-webkit-calendar-picker-indicator{
            filter: invert(1);
        }
    </style>
      
    <div class="table-filter" id="table-filter">
        <div class="table-filter-container">
            <form autocomplete="off">
                                    
                <input autocomplete="false" name="hidden" type="text" style="display:none;">

                <div class="tabs-container-menu">
                    <div class="tabs-container-items">
                        <ul></ul>
                    </div>
                </div>

                <div class="tabs-container-content"></div>
            </form>
        </div>
    </div>`

    const tabsContainerItems = this.shadow.querySelector('.tabs-container-items ul')
    const tabsContainerContent = this.shadow.querySelector('.tabs-container-content')
    const tabs = JSON.parse(this.getAttribute('tabs').replaceAll("'", '"'))

    const index = 0

    // for (const tab in tabs) {
    //   const tabElement = document.createElement('li')
    //   tabElement.classList.add('tab-item')

    //   if (index === 0) {
    //     tabElement.classList.add('active')
    //   }

    //   tabElement.dataset.tab = tab
    //   tabElement.innerHTML = this.formStructure.tabs[tab].label
    //   tabsContainerItems.appendChild(tabElement)

    //   const tabPanel = document.createElement('div')
    //   tabsContainerContent.appendChild(tabPanel)

    //   for (const row in this.formStructure.tabsContent[tab].rows) {
    //     tabPanel.dataset.tab = tab
    //     tabPanel.classList.add('tab-panel')

    //     if (index === 0) {
    //       tabPanel.classList.add('active')
    //     }

    //     const tabPanelRow = document.createElement('div')
    //     tabPanelRow.classList.add('row')

    //     for (const field in this.formStructure.tabsContent[tab].rows[row].formElements) {
    //       const formElement = this.formStructure.tabsContent[tab].rows[row].formElements[field]

    //       const formElementContainer = document.createElement('div')
    //       const formElementLabel = document.createElement('div')
    //       const formElementInput = document.createElement('div')
    //       formElementContainer.appendChild(formElementLabel)
    //       formElementContainer.appendChild(formElementInput)

    //       formElementContainer.classList.add('form-element')
    //       formElementLabel.classList.add('form-element-label')
    //       formElementInput.classList.add('form-element-input')

    //       if (formElement.label) {
    //         const label = document.createElement('label')
    //         label.innerText = formElement.label
    //         label.setAttribute('for', `${formElement.label}`)
    //         formElementLabel.appendChild(label)
    //       }

    //       if (formElement.element === 'input') {
    //         switch (formElement.type) {
    //           case 'checkbox':
    //           case 'radio': {
    //             const inputContainer = document.createElement('div')
    //             inputContainer.classList.add(`${formElement.type}-container`)

    //             formElement.options.forEach(option => {
    //               const input = document.createElement('input')
    //               const inputLabel = document.createElement('label')
    //               inputLabel.innerText = option.label
    //               input.type = formElement.type
    //               input.name = field
    //               input.value = option.value || ''
    //               input.required = formElement.required || false
    //               input.checked = option.checked || false
    //               input.disabled = option.disabled || false

    //               inputContainer.appendChild(inputLabel)
    //               inputContainer.appendChild(input)
    //             })

    //             formElementInput.appendChild(inputContainer)

    //             break
    //           }

    //           case 'range': {
    //             const rangeContainer = document.createElement('div')
    //             rangeContainer.classList.add('range-container')

    //             const input = document.createElement('input')
    //             input.type = formElement.type
    //             input.name = field
    //             input.min = formElement.min || ''
    //             input.max = formElement.max || ''
    //             input.step = formElement.step || ''
    //             input.value = formElement.value || ''
    //             rangeContainer.appendChild(input)

    //             const rangeValue = document.createElement('span')
    //             rangeValue.classList.add('range-value')
    //             rangeValue.innerText = formElement.value
    //             rangeContainer.appendChild(rangeValue)

    //             input.addEventListener('input', () => {
    //               rangeValue.innerText = input.value
    //             })

    //             formElementInput.appendChild(rangeContainer)

    //             break
    //           }

    //           case 'number':
    //           case 'date':
    //           case 'time':
    //           case 'datetime-local':
    //           case 'month':
    //           case 'week': {
    //             const input = document.createElement('input')
    //             input.type = formElement.type
    //             input.name = field
    //             input.min = formElement.min || ''
    //             input.max = formElement.max || ''
    //             input.step = formElement.step || ''
    //             input.placeholder = formElement.placeholder || ''
    //             input.value = formElement.value || ''
    //             input.readOnly = formElement.readOnly || false
    //             input.dataset.validate = formElement.validate || ''

    //             formElementInput.appendChild(input)

    //             break
    //           }

    //           case 'file': {
    //             const input = document.createElement('input')
    //             input.type = formElement.type
    //             input.name = field
    //             input.accept = formElement.accept || ''
    //             input.multiple = formElement.multiple || false
    //             input.required = formElement.required || false
    //             input.dataset.validate = formElement.validate || ''

    //             formElementInput.appendChild(input)

    //             break
    //           }

    //           default: {
    //             const input = document.createElement('input')
    //             input.type = formElement.type
    //             input.name = field
    //             input.value = formElement.value || ''
    //             input.placeholder = formElement.placeholder || ''
    //             input.required = formElement.required || false
    //             input.dataset.validate = formElement.validate || ''

    //             if (formElement.maxLength) {
    //               input.maxLength = formElement.maxLength || ''
    //               const counter = document.createElement('span')
    //               formElementLabel.appendChild(counter)

    //               input.addEventListener('input', () => {
    //                 if (input.value.length > 0) {
    //                   counter.textContent = input.value.length + ' / ' + input.maxLength
    //                 } else {
    //                   counter.textContent = ''
    //                 }
    //               })
    //             }

    //             formElementInput.appendChild(input)

    //             break
    //           }
    //         }
    //       }

    //       if (formElement.element === 'textarea') {
    //         const textarea = document.createElement('textarea')
    //         textarea.name = field
    //         textarea.disabled = formElement.disabled || false
    //         textarea.required = formElement.required || false
    //         textarea.readOnly = formElement.readOnly || false
    //         textarea.value = formElement.value || ''
    //         textarea.cols = formElement.cols || ''
    //         textarea.rows = formElement.rows || ''
    //         textarea.wrap = formElement.wrap || ''
    //         textarea.placeholder = formElement.placeholder || ''

    //         if (formElement.maxLength) {
    //           textarea.maxLength = formElement.maxLength || ''
    //           const counter = document.createElement('span')
    //           formElementLabel.appendChild(counter)

    //           textarea.addEventListener('input', () => {
    //             if (textarea.value.length > 0) {
    //               counter.textContent = textarea.value.length + ' / ' + textarea.maxLength
    //             } else {
    //               counter.textContent = ''
    //             }
    //           })
    //         }

    //         formElementInput.appendChild(textarea)
    //       }

    //       if (formElement.element === 'select') {
    //         const select = document.createElement('select')
    //         select.name = field
    //         select.disabled = formElement.disabled || false
    //         select.required = formElement.required || false
    //         select.multiple = formElement.multiple || false

    //         formElement.options.forEach(option => {
    //           const optionElement = document.createElement('option')
    //           optionElement.value = option.value
    //           optionElement.innerText = option.label
    //           select.appendChild(optionElement)
    //         })

    //         formElementInput.appendChild(select)
    //       }

    //       tabPanelRow.appendChild(formElementContainer)
    //     };

    //     tabPanel.appendChild(tabPanelRow)
    //   };

    //   index++
    // }

    this.renderTabs()
    this.renderButtons()
  }

  renderTabs = () => {
    const tabsContainer = this.shadow.querySelector('.tabs-container-items ul')
    const tabsPanelsContainer = this.shadow.querySelector('.tabs-container-content')
    const tabsItems = this.shadow.querySelectorAll('.tab-item')

    tabsItems.forEach(tabItem => {
      tabItem.addEventListener('click', () => {
        tabsContainer.querySelector('.active').classList.remove('active')
        tabsPanelsContainer.querySelector('.active').classList.remove('active')
        tabItem.classList.add('active')
        tabsPanelsContainer.querySelector(`[data-tab="${tabItem.dataset.tab}"]`).classList.add('active')
      })
    })
  }

  renderButtons () {
    const openFilterButton = this.shadow.getElementById('open-filter')
    const applyFilterButton = this.shadow.getElementById('apply-filter')
    const tableFilter = this.shadow.getElementById('table-filter')

    openFilterButton.addEventListener('click', () => {
      openFilterButton.classList.remove('active')
      applyFilterButton.classList.add('active')
      tableFilter.classList.add('active')
    })

    applyFilterButton.addEventListener('click', async () => {
      const form = this.shadow.querySelector('form')
      const formData = new FormData(form)
      const formDataJson = Object.fromEntries(formData.entries())
      const queryString = new URLSearchParams(formData).toString()
      const method = formDataJson.prompt ? 'POST' : 'GET'
      const endpoint = formDataJson.prompt ? `${import.meta.env.VITE_API_URL}${this.getAttribute('endpoint')}/openai-filter` : `${import.meta.env.VITE_API_URL}${this.getAttribute('endpoint')}?${queryString}`
      const fetchOptions = {
        method,
        headers: {
          'Content-Type': 'application/json'
        }
      }

      if (method === 'POST') {
        fetchOptions.body = JSON.stringify(formDataJson)
      }

      try {
        const response = await fetch(endpoint, fetchOptions)

        if (response.status === 500) {
          const error = await response.json()
          throw error
        }

        if (response.status === 200) {
          this.data = await response.json()

          openFilterButton.classList.add('active')
          applyFilterButton.classList.remove('active')
          tableFilter.classList.remove('active')
          form.reset()

          document.dispatchEvent(new CustomEvent('newFilter', {
            detail: {
              endpoint: this.getAttribute('endpoint'),
              queryString,
              rows: this.data.rows,
              total: this.data.meta.total,
              currentPage: this.data.meta.currentPage,
              lastPage: this.data.meta.pages
            }
          }))
        }
      } catch (error) {
        document.dispatchEvent(new CustomEvent('message', {
          detail: {
            message: error.message || 'Fallo al filtrar los datos',
            type: 'error'
          }
        }))
      }
    })
  }
}

customElements.define('table-filter-component', TableFilter)
;import { isEqual } from 'lodash'
import { store } from '../redux/store.js'
import { showFormElement } from '../redux/crud-slice.js'
import Sortable from 'sortablejs'

class Table extends HTMLElement {
  constructor () {
    super()
    this.shadow = this.attachShadow({ mode: 'open' })
    this.unsubscribe = null
    this.data = []
  }

  async connectedCallback () {
    this.parent = this.getAttribute('parent') ? JSON.parse(this.getAttribute('parent')) : null
    this.language = this.getAttribute('language') || null
    this.structure = JSON.parse(this.getAttribute('structure').replaceAll("'", '"'))

    document.addEventListener('newFilter', this.handleNewFilter.bind(this))

    this.unsubscribe = store.subscribe(() => {
      const currentState = store.getState()

      if (currentState.crud.tableEndpoint === this.getAttribute('endpoint')) {
        this.loadData().then(() => this.render())
      }

      if (currentState.crud.parentElement && this.getAttribute('subtable') && !isEqual(this.parent, currentState.crud.parentElement.data)) {
        this.parent = currentState.crud.parentElement.data
        this.loadData().then(() => this.render())
      }
    })

    if (!this.getAttribute('subtable')) {
      this.loadData().then(() => this.render())
    }
  }

  disconnectedCallback () {
    this.unsubscribe && this.unsubscribe()
  }

  async handleNewFilter (event) {
    if (event.detail.endpoint === this.getAttribute('endpoint')) {
      this.data = event.detail.rows
      this.total = event.detail.total
      this.currentPage = event.detail.currentPage
      this.lastPage = event.detail.lastPage
      this.queryString = event.detail.queryString

      this.render()
    }
  }

  async loadData (data = null) {
    if (data) {
      this.data = data
      return
    }

    let endpoint = `${import.meta.env.VITE_API_URL}${this.getAttribute('endpoint')}`

    const query = [
      this.parent ? `parent=${this.parent.id}` : null,
      this.language ? `language=${this.language}` : null
    ].filter(Boolean).join('&')

    endpoint += query ? `?${query}` : ''

    try {
      const response = await fetch(endpoint)

      if (response.status === 200) {
        const data = await response.json()
        this.data = data.rows

        if (data.meta) {
          this.total = data.meta.total
          this.currentPage = data.meta.currentPage
          this.lastPage = data.meta.pages
        }
      } else if (response.status === 500) {
        throw response
      }
    } catch (error) {
      console.log(error)
    }
  }

  async render () {
    this.shadow.innerHTML =
      /* html */`
      <style>

        button {
          background-color: transparent;
          border: none;
          cursor: pointer;
        }

        .table {
          display: flex;
          flex: 1;
          flex-direction: column;
          gap: 1.5rem;
        }

        .table-buttons {
          background-color: hsl(0, 0%, 100%);
          box-shadow: 5px 10px 19px -7px rgba(0,0,0,0.75);
          display: flex;
          padding: 0 0.5rem;
        }

        .table-button{
          align-items: center;
          display: flex;
          padding: 0.2rem;
        }

        .table-button svg {
          width: 2rem;
        }

        .table-button svg path {
          fill: hsl(236 55% 25%);
        }

        .table-button:hover svg path {
          fill: hsl(272 40% 35%);
        }

        .table-records{
          display: flex;
          flex: 1;
          flex-direction: column;
          gap: 1rem;
          min-height: 70vh;
          max-height: 70vh;
          padding: 1rem 10%;
          overflow-x: hidden;
          overscroll-behavior-y: contain;
          overflow-y: auto;
        }

        :host(.dependant) .table-records {
          min-height: 0;
          padding: 1rem 0;
        }

        .table-records::-webkit-scrollbar{
          width: 0.7rem; 
        }

        .table-records::-webkit-scrollbar-thumb{
          background-color: hsl(236 55% 25%);
        }

        .table-records::-webkit-scrollbar-thumb:hover{
          background-color: hsl(272 40% 35%);
        }

        .table-record-buttons {
          background-color: hsl(0, 0%, 100%);
          display: flex;
          justify-content: flex-end;
        }

        .table-record-buttons button svg{
          width: 2rem;
        }

        .table-record-buttons svg path{
          fill: hsl(236 55% 25%);
        }

        .table-record-buttons button:hover svg path{
          fill: hsl(272 40% 35%);
        }

        .table-no-records {
          background-color: hsl(272 40% 35%);
          padding: 0.7rem;
        }

        :host(.dependant) .table-no-records {
          width: 100%;
        }

        .table-no-records p {
          color: hsl(0, 0%, 100%);
          font-family: 'Lato', sans-serif;
          font-weight: 400;
          margin: 0;
          text-align: center;
        }

        .table-data{
          background-color: hsl(0, 0%, 0%);
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
          list-style: none;
          margin: 0;
          padding: 0.5rem;
        }

        .table-data li{
          color: hsl(0, 0%, 100%);
          font-family: 'Lato', sans-serif;
          font-weight: 400;
        }

        .table-data li span {   
          color: hsl(0, 0%, 100%);
          font-family: 'Lato', sans-serif;  
          font-weight: 400;
        }

        .table-data li span::after {
          content: ":";
          margin-right: 0.5rem;
        }

        .table-pagination{
          background-color: hsl(0, 0%, 100%);
          box-shadow: 5px 10px 19px -7px rgba(0, 0, 0, 0.75);
          display: flex;
          flex-direction: column;
          gap: 1rem;
          padding: 1rem;
        }

        .table-pagination-info{
          display: flex;
          justify-content: space-between;
        }

        .table-pagination-info span{
          color: hsl(0, 0%, 0%);
          font-family: 'Lato', sans-serif;
          font-size: 1rem;
          font-weight: 700;
          margin: 0;
        }

        .table-pagination-pages{
          display: flex;
          gap: 0.5rem;
        }

        .table-pagination-page button{
          color: $secondary-color;
          font-family: sans-serif;
          font-weight: 700;
        }

        .table-pagination-page.active button{
          color: $hover-color;
        }

        .table-pagination-page:hover button{
          color: $hover-color;
        }

        .table-pagination-page.inactive button{
          color: hsl(0, 0%, 69%);
          cursor: not-allowed;
        }

        .sortable-group {
          display: flex;
          flex-direction: column;
          list-style: none;
          padding: 1rem 0;
        }

        .sortable-row {
          background-color: hsl(272 40% 35%);
          border: 1px solid #ddd;
          color: hsl(100, 100%, 100%);
          cursor: move;
          font-family: 'Roboto', sans-serif;
          font-weight: 700;
          margin: 0.5rem 0;
          padding: 1em;
        }

        .sortable-row.sortable-ghost {
          background-color: hsl(19, 100%, 50%);
        }
      </style>

      <section class="table-section">
        <div class="table-buttons"></div>
        <div class="table"></div>
      </section>
    `

    if (this.structure.tableButtons) {
      const tableButtons = this.shadow.querySelector('.table-buttons')

      Object.keys(this.structure.tableButtons).forEach(tableButton => {
        const tableButtonElement = document.createElement('button')
        tableButtonElement.classList.add('table-button')

        if (this.structure.tableButtons[tableButton] === 'filterButton') {
          tableButtonElement.classList.add('table-filter-button')
          tableButtonElement.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11 11L16.76 3.62A1 1 0 0 0 16.59 2.22A1 1 0 0 0 16 2H2A1 1 0 0 0 1.38 2.22A1 1 0 0 0 1.21 3.62L7 11V16.87A1 1 0 0 0 7.29 17.7L9.29 19.7A1 1 0 0 0 10.7 19.7A1 1 0 0 0 11 18.87V11M13 16L18 21L23 16Z" /></svg>
          `
        }

        if (this.structure.tableButtons[tableButton] === 'sortableButton') {
          tableButtonElement.classList.add('sortable-button')
          tableButtonElement.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9,3L5,7H8V14H10V7H13M16,17V10H14V17H11L15,21L19,17H16Z" /></svg>
          `
        }

        tableButtons.appendChild(tableButtonElement)
      })
    }

    if (!this.getAttribute('subtable')) {
      this.shadow.innerHTML +=
      `
        <div class="table-pagination">
          <div class="table-pagination-info">
            <div class="table-pagination-total">      
              <span>${this.total} registro en total</span>
            </div>
            <div class="table-pagination-pages">
              <div class="table-pagination-page" data-pagination="">
                <button><<</button>
              </div>

              <div class="table-pagination-page active" data-pagination="">
                <button>1</button>
              </div>

              <div class="table-pagination-ellipsis">
                <span>...</span>
              </div>

              <div class="table-pagination-page active">
                <button>3</button>
              </div>

              <div class="table-pagination-ellipsis">
                <span>...</span>
              </div>

              <div class="table-pagination-page">
                <button>5</button>
              </div>

              <div class="table-pagination-page" data-pagination="">
                <button>>></button>
              </div>
            </div>
          </div>
        </div>
      `
    }

    await this.getTableData()
    await this.renderTableButtons()
    await this.renderPaginationButtons()
  }

  async getTableData () {
    const table = this.shadow.querySelector('.table')
    const tableRecords = document.createElement('div')
    tableRecords.classList.add('table-records')
    table.appendChild(tableRecords)

    if (this.data.length === 0) {
      const tableNoRecords = document.createElement('div')
      tableNoRecords.classList.add('table-no-records')
      const message = document.createElement('p')
      message.innerHTML = 'No hay registros'
      tableNoRecords.appendChild(message)
      tableRecords.appendChild(tableNoRecords)
      return
    }

    this.data.forEach(element => {
      const tableRow = document.createElement('div')
      tableRow.classList.add('table-row')

      if (this.structure.sortable) {
        tableRow.dataset.id = element.id
      }

      const tableButtons = document.createElement('div')
      tableButtons.classList.add('table-record-buttons')
      tableRow.appendChild(tableButtons)

      const tableRowData = document.createElement('ul')
      tableRowData.classList.add('table-data')
      tableRow.appendChild(tableRowData)

      const headers = this.structure.headers
      const recordButtons = this.structure.recordButtons

      Object.keys(headers).forEach(key => {
        const tableElementData = document.createElement('li')
        const tableDataHeader = document.createElement('span')

        tableDataHeader.classList.add('table-data-header')
        tableDataHeader.innerHTML = headers[key].label
        tableElementData.appendChild(tableDataHeader)

        if (element[headers[key].field]) {
          tableElementData.innerHTML += element[headers[key].field]
        }

        tableRowData.appendChild(tableElementData)
      })

      Object.keys(recordButtons).forEach((recordButton) => {
        const tableButton = document.createElement('button')
        tableButton.classList.add('table-button')

        if (recordButtons[recordButton] === 'edit') {
          tableButton.classList.add('edit-button')
          tableButton.dataset.id = element.id
          tableButton.innerHTML = `
                        <svg viewBox="0 0 24 24">
                            <path fill="currentColor" d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" />
                        </svg>`
        }

        if (recordButtons[recordButton] === 'remove') {
          tableButton.classList.add('remove-button')
          tableButton.dataset.id = element.id
          tableButton.innerHTML = `
                        <svg viewBox="0 0 24 24">
                            <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" />
                        </svg>`
        }

        tableButtons.appendChild(tableButton)
      })

      tableRecords.appendChild(tableRow)
    })
  }

  async renderTableButtons () {
    const tableSection = this.shadow.querySelector('.table-section')

    tableSection.addEventListener('click', async (event) => {
      if (event.target.closest('.sortable-button')) {
        const sortableButton = event.target.closest('.sortable-button')

        if (sortableButton.classList.contains('active')) {
          sortableButton.classList.remove('active')
          sortableButton.querySelector('path').setAttribute('d', 'M9,3L5,7H8V14H10V7H13M16,17V10H14V17H11L15,21L19,17H16Z')
          this.shadow.querySelector('.table').innerHTML = ''
          await this.getTableData()
        } else {
          sortableButton.classList.add('active')
          sortableButton.querySelector('path').setAttribute('d', 'M22,14A2,2 0 0,1 20,16H4A2,2 0 0,1 2,14V10A2,2 0 0,1 4,8H20A2,2 0 0,1 22,10V14M4,14H8V10H4V14M10,14H14V10H10V14M16,14H20V10H16V14Z')
          this.shadow.querySelector('.table').innerHTML = ''
          const table = this.shadow.querySelector('.table')

          let url = `${import.meta.env.VITE_API_URL}${this.getAttribute('endpoint')}/sortable`

          const query = [
            this.parent ? `parent=${this.parent.id}` : null,
            this.language ? `language=${this.language}` : null
          ].filter(Boolean).join('&')

          url += query ? `?${query}` : ''

          this.sortableData = await fetch(url).then(response => response.json())

          console.log(this.sortableData)
          await this.renderSortable(table, this.sortableData)
        }
      }

      if (event.target.closest('.edit-button')) {
        const editButton = event.target.closest('.edit-button')
        let endpoint = import.meta.env.VITE_API_URL + this.getAttribute('endpoint') + '/' + editButton.dataset.id

        const query = [
          this.parent ? `parent=${this.parent.id}` : null,
          this.language ? `language=${this.language}` : null
        ].filter(Boolean).join('&')

        endpoint += query ? `?${query}` : ''

        try {
          const response = await fetch(endpoint)

          if (response.status === 500 || response.status === 404) {
            throw response
          }

          if (response.status === 200) {
            const data = await response.json()

            const formElement = {
              endPoint: this.getAttribute('endpoint'),
              data
            }

            store.dispatch(showFormElement(formElement))
          }
        } catch (error) {
          const data = await error.json()

          document.dispatchEvent(new CustomEvent('message', {
            detail: {
              message: data.message || 'Fallo al cargar el elemento',
              type: 'error'
            }
          }))
        }
      }

      if (event.target.closest('.remove-button')) {
        const removeButton = event.target.closest('.remove-button')

        let element = `${import.meta.env.VITE_API_URL}${this.getAttribute('endpoint')}/${removeButton.dataset.id}`

        const query = [
          this.parent ? `parent=${this.parent.id}` : null,
          this.language ? `language=${this.language}` : null
        ].filter(Boolean).join('&')

        element += query ? `?${query}` : ''

        document.dispatchEvent(new CustomEvent('showDeleteModal', {
          detail: {
            element,
            endPoint: this.getAttribute('endpoint')
          }
        }))
      }
    })
  }

  async renderSortable (parentElement, elements, nestedElement = false) {
    const table = this.shadow.querySelector('.table')
    const group = nestedElement ? parentElement : document.createElement('div')
    group.classList.add('sortable-group')

    if (!nestedElement) {
      parentElement.appendChild(group)
    }

    for (const item in elements) {
      const element = elements[item]

      if (element.parent && !nestedElement) {
        continue
      }

      const row = document.createElement('div')
      row.classList.add('sortable-row')
      console.log(element)
      row.textContent = `${element.label}: ${element.value}`
      row.dataset.id = element.id

      const nestedGroup = document.createElement('div')
      nestedGroup.classList.add('sortable-group')
      row.appendChild(nestedGroup)

      if (element.children) {
        await this.renderSortable(nestedGroup, element.children, true)
      }

      group.appendChild(row)
    }

    if (!nestedElement) {
      table.querySelectorAll('.sortable-group').forEach(group => {
        // eslint-disable-next-line no-new
        new Sortable(group, {
          group: 'nested',
          sort: true,
          animation: 150,
          fallbackOnBody: true,
          swapThreshold: 1,
          onEnd: async (event) => {
            const items = []
            const sortableElements = event.to.querySelectorAll('.sortable-row')
            sortableElements.forEach((element, index) => {
              items.push({
                id: element.dataset.id,
                parent: element.parentElement.parentElement.dataset.id ? element.parentElement.parentElement.dataset.id : null,
                order: index
              })
            })

            let data = {
              items
            }

            data = {
              ...data,
              ...(this.parent && { parent: this.parent.id }),
              ...(this.language && { language: this.language })
            }

            try {
              const url = `${import.meta.env.VITE_API_URL}${this.getAttribute('endpoint')}/update-order`

              const response = fetch(url, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
              })

              if (response.status === 200) {
                document.dispatchEvent(new CustomEvent('message', {
                  detail: {
                    message: data.message || 'Orden guardado correctamente',
                    type: 'success'
                  }
                }))
              }
            } catch (error) {
              document.dispatchEvent(new CustomEvent('message', {
                detail: {
                  message: data.message || 'Fallo al guardar el orden',
                  type: 'error'
                }
              }))
            }
          }
        })
      })
    }
  }

  async renderPaginationButtons () {
    const tablePaginationButtons = this.shadow.querySelectorAll('.table-pagination-button')

    tablePaginationButtons.forEach(tablePaginationButton => {
      tablePaginationButton.addEventListener('click', async () => {
        let page

        switch (tablePaginationButton.id) {
          case 'firstPageUrl':
            page = 1
            break

          case 'previousPageUrl':
            if (this.currentPage === 1) return
            page = parseInt(this.currentPage) - 1
            break

          case 'nextPageUrl':
            if (this.currentPage === this.lastPage) return
            page = parseInt(this.currentPage) + 1
            break

          case 'lastPageUrl':
            page = this.lastPage
            break
        }

        const endpoint = this.queryString ? `${import.meta.env.VITE_API_URL}${this.getAttribute('endpoint')}?page=${page}&${this.queryString}` : `${import.meta.env.VITE_API_URL}${this.getAttribute('endpoint')}?page=${page}`

        try {
          const response = await fetch(endpoint)

          if (response.status === 500) {
            throw response
          }

          if (response.status === 200) {
            const data = await response.json()
            this.data = data.rows
            this.total = data.meta.total
            this.currentPage = data.meta.currentPage
            this.lastPage = data.meta.pages

            this.render()
          }
        } catch (error) {
          const data = await error.json()

          document.dispatchEvent(new CustomEvent('message', {
            detail: {
              message: data.message || 'Fallo al cargar los datos',
              type: 'error'
            }
          }))
        }
      })
    })
  }
}

customElements.define('table-component', Table)
;import { isEqual } from 'lodash'
import { store } from '../redux/store.js'
import { refreshTable, setParentElement } from '../redux/crud-slice.js'
import { showImages, removeImages } from '../redux/images-slice.js'

class Form extends HTMLElement {
  constructor () {
    super()
    this.shadow = this.attachShadow({ mode: 'open' })
    this.unsubscribe = null
    this.parent = null
    this.formElementData = null
    this.languages = null
  }

  async connectedCallback () {
    this.parent = this.getAttribute('parent') ? JSON.parse(this.getAttribute('parent')) : null
    this.structure = JSON.parse(this.getAttribute('structure').replaceAll("'", '"'))

    this.unsubscribe = store.subscribe(() => {
      const currentState = store.getState()

      if (currentState.crud.formElement && currentState.crud.formElement.endPoint === this.getAttribute('endpoint') && !isEqual(this.formElementData, currentState.crud.formElement.data)) {
        this.formElementData = currentState.crud.formElement.data

        if (!this.parent || !this.formElementData.locales || Object.keys(this.formElementData.locales)[0] === this.languages.value) {
          this.showElement(this.formElementData)
        }
      }

      if (currentState.crud.formElement.data === null && currentState.crud.formElement.endPoint === this.getAttribute('endpoint') && !isEqual(this.formElementData, currentState.crud.formElement.data)) {
        this.resetForm(this.shadow.querySelector('form'))
      }

      if (currentState.crud.parentElement && this.getAttribute('subform') && !isEqual(this.parent, currentState.crud.parentElement.data)) {
        this.parent = currentState.crud.parentElement.data
        this.render()
      }
    })

    if (this.getAttribute('language')) {
      this.languages = JSON.parse(this.getAttribute('language'))
    } else {
      await this.getLanguages()
    }

    this.render()
  }

  disconnectedCallback () {
    this.unsubscribe && this.unsubscribe()
  }

  getLanguages = async () => {
    if (!window.sessionStorage.getItem('languages')) {
      const endpoint = `${import.meta.env.VITE_API_URL}/api/admin/languages/get-languages`

      try {
        const response = await fetch(endpoint)

        if (response.ok) {
          const data = await response.json()
          this.languages = data
          window.sessionStorage.setItem('languages', JSON.stringify(data))
        }
      } catch (error) {
        console.log(error)
      }
    } else {
      this.languages = JSON.parse(window.sessionStorage.getItem('languages'))
    }
  }

  render = async () => {
    this.shadow.innerHTML =
      /* html */`
        <style>
          .tabs-container-menu{
            background-color: hsl(100, 100%, 100%);
            display: flex;
            height: 2.5em;
            justify-content: space-between;
            width: 100%;
          }

          .tabs-container-content .tabs-container-menu{
            margin-top: 1rem;
          }
          
          .tabs-container-menu ul{
            height: 2.5rem;
            display: flex;
            margin: 0;
            padding: 0;
          }
          
          .tabs-container-menu li{
            background: hsl(272deg 40% 35% / 50%);
            border-right: 1px solid hsl(0 0% 50%);
            color: hsl(236 55% 25%);
            cursor: pointer;
            font-family: 'Lato' , sans-serif;
            list-style: none;
            font-weight: 600;
            padding: 0.5rem;
            text-align: center;
          }
          
          .tabs-container-menu li.active,
          .tabs-container-menu li.active:hover{
            background-color: hsl(272 40% 35%);
            color: white;
          }

          .tabs-container-buttons{
            display: flex;
            gap: 0.5rem;
            padding: 0 0.5rem;
          }

          .tabs-container-buttons svg{
            cursor: pointer;
            height: 2.5rem;
            width: 2.5rem;
            fill: hsl(236 55% 25%);
          }

          .tabs-container-buttons svg:hover{
            fill: hsl(272 40% 35%);
          }

          .errors-container{
            background-color: hsl(0, 0%, 100%);
            display: none;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
            padding: 1rem;
          }

          .errors-container.active{
            display: flex;
          }

          .errors-container .error-container{
            width: 100%;
          }

          .errors-container .error-container span{
            color: hsl(0, 0%, 50%);
            font-family: 'Lato' , sans-serif;
            font-size: 1rem;
            font-weight: 600;
          }
          
          .tab-panel{
            display: none;
          }
          
          .tab-panel.active{
            display: flex;
            flex-wrap: wrap;
            gap: 1%;
            padding: 1rem 0;
            width: 100%;
          }

          .form-element{
            margin-bottom: 1em;
            width: 100%;
          }

          .form-element.hidden{
            display: none;
          }

          .form-element.full-width {
            flex: 0 0 100%;
          }

          .form-element.half-width {
            flex: 0 0 49.5%;
          }

          .form-element.one-third-width {
            flex: 0 0 32.65%;
          }

          .form-element.one-quarter-width {
            flex: 0 0 24.25%;
          }

          .form-element-label{
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            width: 100%;
          }
          
          .form-element-label label,
          .form-element-label span{
            color: hsl(0, 0%, 100%);
            font-family: 'Lato' , sans-serif;
            font-weight: 600;
            font-size: 1rem;
            transition: color 0.5s;
          }

          .form-element-label label.invalid::after{
            content: '*';
            color: hsl(0, 100%, 50%);
            font-size: 1.5rem;
            margin-left: 0.2rem;
          }

          .form-element-label,
          .form-element-input{
            width: 100%;
          }

          input[type="submit"]{
            background: none;
            color: inherit;
            border: none;
            padding: 0;
            font: inherit;
            cursor: pointer;
            outline: inherit;
          }
          
          .form-element-input input, 
          .form-element-input textarea,
          .form-element-input select {
            background-color:hsl(226deg 64% 66%);
            border: none;
            border-bottom: 0.1em solid hsl(0, 0%, 100%);
            border-radius: 0;
            box-sizing: border-box;
            color: hsl(0, 0%, 100%);
            height: 2.2rem;
            font-family: 'Lato' , sans-serif;
            font-size: 1rem;
            font-weight: 600;
            padding: 0 0.5rem;
            width: 100%;
          }

          .form-element-input input:focus,
          .form-element-input textarea:focus,
          .form-element-input select:focus{
            outline: none;
            border-bottom: 0.1rem solid hsl(207, 85%, 69%);
          }

          .form-element-input input.invalid,
          .form-element-input textarea.invalid{
            border-bottom: 0.2rem solid hsl(0, 100%, 50%);
          }

          .form-element-input textarea{
            height: 10rem;
            padding: 0.5rem;
          }

          .form-element-input .checkbox-container,
          .form-element-input .radio-container{
            display: flex;
            align-items: center;
            gap: 0.5rem;
          }

          .form-element-input .checkbox-container input,
          .form-element-input .radio-container input{
            width: 1rem;
            height: 1rem;
          }

          .form-element-input .checkbox-container label,
          .form-element-input .radio-container label{
            color: hsl(0, 0%, 100%);
            font-family: 'Lato' , sans-serif;
            font-weight: 600;
            font-size: 1rem;
          }

          .form-element-input .range-container{
            display: flex;
            align-items: center;
            gap: 0.5rem;
          }

          .form-element-input .range-container input{
            width: 100%;
          }

          .form-element-input .range-container label{
            color: hsl(0, 0%, 100%);
            font-family: 'Lato' , sans-serif;
            font-weight: 600;
            font-size: 1rem;
          }

          .form-element-input .range-container .range-value{
            color: hsl(0, 0%, 100%);
            font-family: 'Lato' , sans-serif;
            font-weight: 600;
            font-size: 1rem;
          }

          .form-element-input .range-container input[type="range"]{
            -webkit-appearance: none;
            width: 100%;
            height: 0.5rem;
            border-radius: 0.5rem;
            background: hsl(0, 0%, 100%);
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
          }

          .form-element-input input[type="time"]::-webkit-calendar-picker-indicator,
          .form-element-input input[type="date"]::-webkit-calendar-picker-indicator{
            filter: invert(1);
          }

          .dependants-container{
            display: none;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
          }

          .dependants-container.active{
            display: flex;
          }

          .relateds-container{
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
          }

          .dependants-container .dependant-container,
          .relateds-container .related-container{
            background-color: hsl(272deg 40% 35% / 30%);
            height: auto;
            padding: 1rem;
          }

          .dependants-container .dependant-header,
          .relateds-container .related-header{
            align-items: center;
            display: flex;
            height: 2.5rem;
          }

          .dependants-container .dependant-header span,
          .relateds-container .related-header span{
            color: hsl(0 0% 100%);
            font-family: 'Lato' , sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
          }

          .dependants-container .dependants-components,
          .relateds-container .relateds-components{
            display: flex;
            flex-wrap: wrap;
            gap: 1%;
            justify-content: space-between;
            padding: 1rem 0;
            width: 100%
          }

          .dependants-container .dependants-components div,
          .relateds-container .relateds-components div{
            width: 49%;
          }
        </style>
      `

    const form = document.createElement('form')
    form.setAttribute('autocomplete', 'off')
    this.shadow.append(form)

    // const dependantsContainer = document.createElement('div')
    // dependantsContainer.classList.add('dependants-container')
    // this.shadow.append(dependantsContainer)

    this.createFormTemplate(form)
    this.createTabsContent(form)
    this.renderTabs()
    this.renderSubmitForm()
    this.renderCreateForm()
  }

  createFormTemplate (form) {
    const autocompleteInput = document.createElement('input')
    autocompleteInput.setAttribute('autocomplete', 'false')
    autocompleteInput.setAttribute('name', 'hidden')
    autocompleteInput.setAttribute('type', 'text')
    autocompleteInput.style.display = 'none'
    form.append(autocompleteInput)

    const errorsContainer = document.createElement('div')
    errorsContainer.classList.add('errors-container')
    form.append(errorsContainer)

    return form
  }

  createTabsContent = (form) => {
    const tabsCointainerMenu = document.createElement('div')
    tabsCointainerMenu.classList.add('tabs-container-menu')
    form.append(tabsCointainerMenu)

    const tabsContainerItems = document.createElement('div')
    tabsContainerItems.classList.add('tabs-container-items')
    tabsCointainerMenu.append(tabsContainerItems)

    const tabsContainerItemsUl = document.createElement('ul')
    tabsContainerItems.append(tabsContainerItemsUl)

    const tabsContainerButtons = document.createElement('div')
    tabsContainerButtons.classList.add('tabs-container-buttons')
    tabsCointainerMenu.append(tabsContainerButtons)

    const createButton = document.createElement('div')
    createButton.id = 'create-button'
    tabsContainerButtons.append(createButton)
    createButton.innerHTML = `
      <svg viewBox="0 0 24 24">
        <path d="M19.36,2.72L20.78,4.14L15.06,9.85C16.13,11.39 16.28,13.24 15.38,14.44L9.06,8.12C10.26,7.22 12.11,7.37 13.65,8.44L19.36,2.72M5.93,17.57C3.92,15.56 2.69,13.16 2.35,10.92L7.23,8.83L14.67,16.27L12.58,21.15C10.34,20.81 7.94,19.58 5.93,17.57Z" />
      </svg>
    `

    const storeButton = document.createElement('div')
    storeButton.id = 'store-button'
    tabsContainerButtons.append(storeButton)
    const label = document.createElement('label')
    storeButton.append(label)
    const input = document.createElement('input')
    input.type = 'submit'
    input.value = ''
    label.append(input)
    label.innerHTML += `
      <svg viewBox="0 0 24 24">
        <path d="M0 0h24v24H0z" fill="none"/>
        <path class="crud__create-button-icon" d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
      </svg>
    `

    const tabsContainerContent = document.createElement('div')
    tabsContainerContent.classList.add('tabs-container-content')
    form.append(tabsContainerContent)

    for (const tab in this.structure.tabs) {
      const tabName = this.structure.tabs[tab].name

      const tabElement = document.createElement('li')
      tabElement.classList.add('tab-item')
      tabElement.dataset.tab = tabName
      tabElement.innerHTML = this.structure.tabs[tab].label
      tabsContainerItemsUl.append(tabElement)

      const tabPanel = document.createElement('div')
      tabPanel.dataset.tab = tabName
      tabPanel.classList.add('tab-panel')
      tabsContainerContent.append(tabPanel)

      if (this.structure.inputs[tabName].noLocale) {
        this.createFormElements(form, tabPanel, this.structure.inputs[tabName].noLocale, this.getAttribute('language') ? this.languages.value : null)
      }

      if (this.structure.inputs[tabName].locale) {
        const localeTabsContainer = document.createElement('div')
        localeTabsContainer.classList.add('tabs-container-menu')
        tabPanel.append(localeTabsContainer)

        const localeTabsContainerItems = document.createElement('div')
        localeTabsContainerItems.classList.add('tabs-container-items')
        localeTabsContainer.append(localeTabsContainerItems)

        const localeTabsContainerItemsUl = document.createElement('ul')
        localeTabsContainerItems.append(localeTabsContainerItemsUl)

        this.languages.forEach((language, index) => {
          const localeTabElement = document.createElement('li')
          localeTabElement.classList.add('tab-item')
          localeTabElement.dataset.tab = `${tabName}-${language.value}`
          localeTabElement.innerHTML = language.label
          localeTabsContainerItemsUl.append(localeTabElement)

          const localeTabPanel = document.createElement('div')
          localeTabPanel.dataset.tab = `${tabName}-${language.value}`
          localeTabPanel.classList.add('tab-panel')
          tabPanel.append(localeTabPanel)

          if (index === 0) {
            localeTabElement.classList.add('active')
            localeTabPanel.classList.add('active')
          }

          this.createFormElements(form, localeTabPanel, this.structure.inputs[tabName].locale, language.value)
        })
      }
    }
  }

  createFormElements = async (form, tabPanel, elements, languageAlias = null) => {
    for (const field in elements) {
      const formElement = elements[field]
      const formElementContainer = document.createElement('div')
      formElementContainer.classList.add('form-element', formElement.width || 'full-width')

      if (formElement.label) {
        const formElementLabel = document.createElement('div')
        formElementContainer.append(formElementLabel)
        formElementLabel.classList.add('form-element-label')

        const label = document.createElement('label')
        label.innerText = formElement.label
        languageAlias ? label.setAttribute('for', `${formElement.name}-${languageAlias}`) : label.setAttribute('for', formElement.name)
        formElementLabel.append(label)
      }

      const formElementInput = document.createElement('div')
      formElementContainer.append(formElementInput)
      formElementInput.classList.add('form-element-input')

      if (formElement.element === 'input') {
        switch (formElement.type) {
          case 'hidden': {
            const input = document.createElement('input')
            input.type = formElement.type
            input.name = (languageAlias && formElement.name !== 'id') ? `locales.${languageAlias}.${formElement.name}` : formElement.name
            input.value = formElement.value || ''

            form.append(input)

            continue
          }

          case 'checkbox':
          case 'radio': {
            const inputContainer = document.createElement('div')
            inputContainer.classList.add(`${formElement.type}-container`)

            if (formElement.endpoint) {
              let url = `${import.meta.env.VITE_API_URL}${formElement.endpoint}`

              if (formElement['parent-filter'] && this.parent) {
                const query = formElement['parent-filter'].map(filter => `${filter}=${encodeURIComponent(this.parent[filter] ?? '')}`)

                if (languageAlias) {
                  query.push(`languageAlias=${languageAlias}`)
                }

                url += `?${query.join('&')}`
              }

              const response = await fetch(url)
              formElement.options = await response.json()
            }

            formElement.options.forEach(option => {
              const input = document.createElement('input')
              const inputLabel = document.createElement('label')
              inputLabel.innerText = option.label
              input.id = languageAlias ? `${formElement.name}-${languageAlias}` : formElement.name
              input.type = formElement.type
              input.name = languageAlias ? `locales.${languageAlias}.${formElement.name}` : formElement.name
              input.name = formElement.prefix ? `${formElement.prefix}.${input.name}` : input.name
              input.value = option.value || ''
              input.checked = option.checked || false
              input.disabled = option.disabled || false

              inputContainer.append(inputLabel)
              inputContainer.append(input)
            })

            formElementInput.append(inputContainer)

            break
          }

          case 'range': {
            const rangeContainer = document.createElement('div')
            rangeContainer.classList.add('range-container')

            const input = document.createElement('input')
            input.id = languageAlias ? `${formElement.name}-${languageAlias}` : formElement.name
            input.type = formElement.type
            input.name = languageAlias ? `locales.${languageAlias}.${formElement.name}` : formElement.name
            input.name = formElement.prefix ? `${formElement.prefix}.${input.name}` : input.name
            input.min = formElement.min || ''
            input.max = formElement.max || ''
            input.step = formElement.step || ''
            input.value = formElement.value || ''
            rangeContainer.append(input)

            if (formElement.relatedvalue) {
              formElementContainer.classList.add('hidden')
              input.dataset.relatedInput = formElement.relatedinput
              input.dataset.relatedValue = formElement.relatedvalue
              input.disabled = true
            }

            const rangeValue = document.createElement('span')
            rangeValue.classList.add('range-value')
            rangeValue.innerText = formElement.value
            rangeContainer.append(rangeValue)

            input.addEventListener('input', () => {
              rangeValue.innerText = input.value
            })

            formElementInput.append(rangeContainer)

            break
          }

          case 'number':
          case 'date':
          case 'time':
          case 'datetime-local':
          case 'month':
          case 'week': {
            const input = document.createElement('input')
            input.id = languageAlias ? `${formElement.name}-${languageAlias}` : formElement.name
            input.type = formElement.type
            input.name = languageAlias ? `locales.${languageAlias}.${formElement.name}` : formElement.name
            input.name = formElement.prefix ? `${formElement.prefix}.${input.name}` : input.name
            input.min = formElement.min || ''
            input.max = formElement.max || ''
            input.step = formElement.step || ''
            input.placeholder = formElement.placeholder || ''
            input.value = formElement.value || ''
            input.readOnly = formElement.readOnly || false
            input.dataset.validate = formElement.validate || ''

            if (formElement.relatedvalue) {
              formElementContainer.classList.add('hidden')
              input.dataset.relatedInput = formElement.relatedinput
              input.dataset.relatedValue = formElement.relatedvalue
              input.disabled = true
            }

            formElementInput.append(input)

            break
          }

          case 'image': {
            const input = document.createElement('upload-image-button-component')
            input.id = languageAlias ? `${formElement.name}-${languageAlias}` : formElement.name
            input.setAttribute('name', formElement.name)
            languageAlias ? input.setAttribute('language-alias', languageAlias) : input.setAttribute('language-alias', import.meta.env.VITE_DEFAULT_LANGUAGE)
            input.setAttribute('quantity', formElement.quantity)
            input.setAttribute('image-configurations', JSON.stringify(formElement.imageConfigurations))

            formElementInput.append(input)

            break
          }

          default: {
            const input = document.createElement('input')
            input.id = languageAlias ? `${formElement.name}-${languageAlias}` : formElement.name
            input.type = formElement.type
            input.name = languageAlias ? `locales.${languageAlias}.${formElement.name}` : formElement.name
            input.name = formElement.prefix ? `${formElement.prefix}.${input.name}` : input.name
            input.value = formElement.value || ''
            input.placeholder = formElement.placeholder || ''
            input.dataset.validate = formElement.validate || ''

            if (formElement.relatedvalue) {
              formElementContainer.classList.add('hidden')
              input.dataset.relatedInput = formElement.relatedinput
              input.dataset.relatedValue = formElement.relatedvalue
              input.disabled = true
            }

            if (formElement.maxLength) {
              input.maxLength = formElement.maxLength || ''
              const counter = document.createElement('span')
              formElementLabel.append(counter)

              input.addEventListener('input', () => {
                if (input.value.length > 0) {
                  counter.textContent = input.value.length + ' / ' + input.maxLength
                } else {
                  counter.textContent = ''
                }
              })
            }

            formElementInput.append(input)

            break
          }
        }
      }

      if (formElement.element === 'textarea') {
        const textarea = document.createElement('textarea')
        textarea.id = languageAlias ? `${formElement.name}-${languageAlias}` : formElement.name
        textarea.name = languageAlias ? `locales.${languageAlias}.${formElement.name}` : formElement.name
        textarea.disabled = formElement.disabled || false
        textarea.readOnly = formElement.readOnly || false
        textarea.value = formElement.value || ''
        textarea.cols = formElement.cols || ''
        textarea.rows = formElement.rows || ''
        textarea.wrap = formElement.wrap || ''
        textarea.placeholder = formElement.placeholder || ''
        textarea.dataset.validate = formElement.validate || ''

        if (formElement.relatedvalue) {
          formElementContainer.classList.add('hidden')
          textarea.dataset.relatedInput = formElement.relatedinput
          textarea.dataset.relatedValue = formElement.relatedvalue
          textarea.disabled = true
        }

        if (formElement.maxLength) {
          textarea.maxLength = formElement.maxLength || ''
          const counter = document.createElement('span')
          formElementLabel.append(counter)

          textarea.addEventListener('keydown', event => {
            if (event.key === 'Tab') {
              event.preventDefault()
              alert('hoa')
              const start = this.selectionStart
              const end = this.selectionEnd
              this.value = this.value.substring(0, start) + '  ' + this.value.substring(end)
              this.selectionStart = this.selectionEnd = start + 2
            }
          })

          textarea.addEventListener('input', () => {
            if (textarea.value.length > 0) {
              counter.textContent = textarea.value.length + ' / ' + textarea.maxLength
            } else {
              counter.textContent = ''
            }
          })
        }

        formElementInput.append(textarea)
      }

      if (formElement.element === 'select') {
        const select = document.createElement('select')
        select.id = languageAlias ? `${formElement.name}-${languageAlias}` : formElement.name
        select.name = languageAlias ? `locales.${languageAlias}.${formElement.name}` : formElement.name
        select.disabled = formElement.disabled || false
        select.required = formElement.required || false
        select.multiple = formElement.multiple || false

        if (formElement.relatedvalue) {
          formElementContainer.classList.add('hidden')
          select.dataset.relatedInput = formElement.relatedinput
          select.dataset.relatedValue = formElement.relatedvalue
          select.disabled = true
        }

        if (formElement.related) {
          select.addEventListener('change', async (event) => {
            this.shadow.querySelectorAll(`[data-related-input="${formElement.name}"]`).forEach(input => {
              const isDifferent = input.dataset.relatedValue !== event.target.value
              input.disabled = isDifferent
              const parentFormElement = input.closest('.form-element')
              if (parentFormElement) {
                if (isDifferent) {
                  parentFormElement.classList.add('hidden')
                } else {
                  parentFormElement.classList.remove('hidden')
                }
              }
            })
          })
        }

        if (formElement.endpoint) {
          let url = `${import.meta.env.VITE_API_URL}${formElement.endpoint}`

          if (formElement['parent-filter'] && this.parent) {
            const query = formElement['parent-filter'].map(filter => `${filter}=${encodeURIComponent(this.parent[filter] ?? '')}`)

            if (languageAlias) {
              query.push(`languageAlias=${languageAlias}`)
            }

            url += `?${query.join('&')}`
          }

          const response = await fetch(url)
          formElement.options = await response.json()
        }

        const defaultOption = document.createElement('option')
        defaultOption.value = ''
        defaultOption.innerText = 'Selecciona una opción'
        select.append(defaultOption)

        formElement.options.forEach(option => {
          const optionElement = document.createElement('option')
          optionElement.value = option.value
          optionElement.innerText = option.label
          select.append(optionElement)
        })

        formElementInput.append(select)
      }

      if (formElement.element === 'dependants') {
        const dependantsContainer = document.createElement('div')
        dependantsContainer.classList.add('dependants-container')
        tabPanel.append(dependantsContainer)

        formElement.childs.forEach(dependant => {
          const dependantContainer = document.createElement('div')
          dependantContainer.classList.add('dependant-container')
          dependantsContainer.append(dependantContainer)

          const dependantHeader = document.createElement('div')
          dependantHeader.classList.add('dependant-header')
          dependantContainer.append(dependantHeader)

          const dependantTitle = document.createElement('span')
          dependantTitle.innerText = dependant.label
          dependantHeader.append(dependantTitle)

          if (dependant.locale) {
            const localeTabsContainer = document.createElement('div')
            localeTabsContainer.classList.add('tabs-container-menu')
            dependantContainer.append(localeTabsContainer)

            const localeTabsContainerItems = document.createElement('div')
            localeTabsContainerItems.classList.add('tabs-container-items')
            localeTabsContainer.append(localeTabsContainerItems)

            const localeTabsContainerItemsUl = document.createElement('ul')
            localeTabsContainerItems.append(localeTabsContainerItemsUl)

            this.languages.forEach((language, index) => {
              const localeTabElement = document.createElement('li')
              localeTabElement.classList.add('tab-item')
              localeTabElement.dataset.tab = `${dependant.name}-${language.value}`
              localeTabElement.innerHTML = language.label
              localeTabsContainerItemsUl.append(localeTabElement)

              const localeTabPanel = document.createElement('div')
              localeTabPanel.dataset.tab = `${dependant.name}-${language.value}`
              localeTabPanel.classList.add('tab-panel')
              dependantContainer.append(localeTabPanel)

              const dependantsComponents = document.createElement('div')
              dependantsComponents.classList.add('dependants-components')
              localeTabPanel.append(dependantsComponents)

              if (index === 0) {
                localeTabElement.classList.add('active')
                localeTabPanel.classList.add('active')
              }

              dependant.structure.forEach(component => {
                if (component.element === 'subform') {
                  const subformContainer = document.createElement('div')
                  subformContainer.classList.add('subform-container')

                  const formComponent = document.createElement('form-component')
                  formComponent.classList.add('dependant')
                  formComponent.setAttribute('subform', dependant.name)
                  formComponent.setAttribute('endpoint', component.endpoint)
                  formComponent.setAttribute('language', JSON.stringify(language))
                  formComponent.setAttribute('structure', JSON.stringify(component.structure))
                  subformContainer.append(formComponent)

                  dependantsComponents.append(subformContainer)
                }

                if (component.element === 'subtable') {
                  const subtableContainer = document.createElement('div')
                  subtableContainer.classList.add('subtable-container')

                  const tableComponent = document.createElement('table-component')
                  tableComponent.classList.add('dependant')
                  tableComponent.setAttribute('subtable', dependant.name)
                  tableComponent.setAttribute('endpoint', component.endpoint)
                  tableComponent.setAttribute('language', language.value)
                  tableComponent.setAttribute('structure', JSON.stringify(component.structure))
                  subtableContainer.append(tableComponent)

                  dependantsComponents.append(subtableContainer)
                }
              })
            })
          } else {
            const dependantsComponents = document.createElement('div')
            dependantsComponents.classList.add('dependants-components')
            dependantContainer.append(dependantsComponents)

            dependant.structure.forEach(component => {
              if (component.element === 'subform') {
                const subformContainer = document.createElement('div')
                subformContainer.classList.add('subform-container')

                const formComponent = document.createElement('form-component')
                formComponent.classList.add('dependant')
                formComponent.setAttribute('subform', dependant.name)
                formComponent.setAttribute('endpoint', component.endpoint)
                formComponent.setAttribute('structure', JSON.stringify(component.structure))
                subformContainer.append(formComponent)

                dependantsComponents.append(subformContainer)
              }

              if (component.element === 'subtable') {
                const subtableContainer = document.createElement('div')
                subtableContainer.classList.add('subtable-container')

                const tableComponent = document.createElement('table-component')
                tableComponent.classList.add('dependant')
                tableComponent.setAttribute('subtable', dependant.name)
                tableComponent.setAttribute('endpoint', component.endpoint)
                tableComponent.setAttribute('structure', JSON.stringify(component.structure))
                subtableContainer.append(tableComponent)

                dependantsComponents.append(subtableContainer)
              }
            })
          }
        })
      }

      tabPanel.append(formElementContainer)
    }
  }

  renderTabs = () => {
    this.shadow.querySelector('.tab-item').classList.add('active')
    this.shadow.querySelector('.tab-panel').classList.add('active')
    const form = this.shadow.querySelector('form')

    form.addEventListener('click', (event) => {
      if (event.target.closest('.tab-item')) {
        if (event.target.closest('.tab-item').classList.contains('active')) {
          return
        }

        const tabClicked = event.target.closest('.tab-item')
        const tabActive = tabClicked.parentElement.querySelector('.active')

        tabClicked.classList.add('active')
        tabActive.classList.remove('active')

        tabClicked.closest('form').querySelector(`.tab-panel.active[data-tab="${tabActive.dataset.tab}"]`).classList.remove('active')
        tabClicked.closest('form').querySelector(`.tab-panel[data-tab="${tabClicked.dataset.tab}"]`).classList.add('active')
      }
    })
  }

  renderSubmitForm = () => {
    this.shadow.querySelector('#store-button').addEventListener('click', async (event) => {
      event.preventDefault()

      const form = this.shadow.querySelector('form')

      if (!this.validateForm(form.elements)) {
        return
      }

      const formData = new FormData(form)
      const formDataJson = {}

      for (const [key, value] of formData.entries()) {
        if (key.includes('locales')) {
          const [prefix, locales, field] = key.split('.')

          if (!(prefix in formDataJson)) {
            formDataJson[prefix] = {}
          }

          if (!(locales in formDataJson[prefix])) {
            formDataJson[prefix][locales] = {}
          }

          formDataJson[prefix][locales][field] = value ?? null
        } else if (key.includes('.')) {
          const [prefix, field] = key.split('.')

          if (!(prefix in formDataJson)) {
            formDataJson[prefix] = {}
          }

          formDataJson[prefix][field] = value ?? null
        } else {
          formDataJson[key] = value ?? null
        }
      }

      if (this.shadow.querySelectorAll('input[type="checkbox"]').length > 0) {
        const checkboxesByName = {}

        this.shadow.querySelectorAll('input[type="checkbox"]:checked').forEach(checkedCheckbox => {
          if (!checkboxesByName[checkedCheckbox.name]) {
            checkboxesByName[checkedCheckbox.name] = []
          }

          checkboxesByName[checkedCheckbox.name].push(checkedCheckbox.value)
        })

        Object.keys(checkboxesByName).forEach(name => {
          if (name.includes('.')) {
            const [prefix, field] = name.split('.')
            formDataJson[prefix][field] = checkboxesByName[name]
          } else {
            formDataJson[name] = checkboxesByName[name]
          }
        })
      }

      formDataJson.images = store.getState().images.selectedImages

      this.parent && (formDataJson.parentId = this.parent.id)
      this.languages.value && (formDataJson.language = this.languages.value)

      const endpoint = formDataJson.id ? `${import.meta.env.VITE_API_URL}${this.getAttribute('endpoint')}/${formDataJson.id}` : `${import.meta.env.VITE_API_URL}${this.getAttribute('endpoint')}`
      const method = formDataJson.id ? 'PUT' : 'POST'
      delete formDataJson.id

      try {
        const response = await fetch(endpoint, {
          method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formDataJson)
        })

        if (response.status === 500 || response.status === 422) {
          throw response
        }

        if (response.status === 200) {
          const data = await response.json()

          document.dispatchEvent(new CustomEvent('message', {
            detail: {
              message: 'Datos guardados correctamente',
              type: 'success'
            }
          }))

          if (!this.shadow.querySelector('.dependants-container')) {
            this.resetForm(form)
          } else {
            store.dispatch(setParentElement({ endPoint: this.getAttribute('endpoint'), data }))
            this.shadow.querySelector('.errors-container').classList.remove('active')
            this.shadow.querySelector('.errors-container').innerHTML = ''
            this.shadow.querySelector("[name='id']").value = data.id
            this.shadow.querySelector('.dependants-container').classList.add('active')

            if (this.getAttribute('relateds')) {
              this.showRelateds(data)
            }
          }

          store.dispatch(refreshTable(this.getAttribute('endpoint')))
        }
      } catch (error) {
        const data = await error.json()

        if (data.errors) {
          data.errors.forEach(error => {
            const errorContainer = document.createElement('div')
            const errorMessage = document.createElement('span')
            errorContainer.classList.add('error-container')
            errorMessage.textContent = error.message
            errorContainer.append(errorMessage)

            this.shadow.querySelector('.errors-container').append(errorContainer)
            this.shadow.querySelector('.errors-container').classList.add('active')
          })

          document.dispatchEvent(new CustomEvent('message', {
            composed: true,
            detail: {
              message: 'Fallo al guardar los datos',
              type: 'error'
            }
          }))
        }

        if (data.message) {
          document.dispatchEvent(new CustomEvent('message', {
            detail: {
              message: data.message || 'Fallo al guardar los datos',
              type: 'error'
            }
          }))
        }
      }
    })
  }

  renderCreateForm = () => {
    this.shadow.querySelector('#create-button').addEventListener('click', () => {
      this.resetForm(this.shadow.querySelector('form'))
    })
  }

  resetForm = async form => {
    form.reset()

    this.shadow.querySelector("[name='id']").value = ''

    this.shadow.querySelectorAll(".tab-item[data-tab='active']").forEach(tab => {
      tab.classList.remove('active')
      tab.parentElement.querySelector('.tab-item').classList.add('active')
    })

    this.shadow.querySelectorAll(".tab-panel[data-tab='active']").forEach(tabPanel => {
      tabPanel.classList.remove('active')
      tabPanel.parentElement.querySelector('.tab-panel').classList.add('active')
    })

    this.shadow.querySelector('.errors-container').innerHTML = ''

    this.shadow.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = false
    })

    this.shadow.querySelectorAll('input[type="radio"]').forEach(radio => {
      radio.checked = false
    })

    this.shadow.querySelectorAll('select').forEach(select => {
      select.selectedIndex = 0
    })

    this.shadow.querySelector('.dependants-container')?.classList.remove('active')

    store.dispatch(removeImages())
  }

  showElement = async element => {
    await this.resetForm(this.shadow.querySelector('form'))

    Object.entries(element).forEach(([key, value]) => {
      if (this.shadow.querySelector(`[name="${key}"]`)) {
        if (typeof value === 'object') {
          value = JSON.stringify(value, null, 2)
        }

        const input = this.shadow.querySelector(`[name="${key}"]`)

        if (input.tagName === 'INPUT' || input.tagName === 'TEXTAREA') {
          if (input.type !== 'checkbox' && input.type !== 'radio') {
            input.value = value !== 'null' ? value : ''
          }
        }

        if (input.tagName === 'SELECT') {
          const options = input.querySelectorAll('option')
          options.forEach(option => {
            if (option.value === value.toString()) {
              option.selected = true
            }
          })
          input.dispatchEvent(new Event('change'))
        }

        if (input.type === 'radio') {
          const radios = this.shadow.querySelector(`[name="${key}"]`).closest('.form-element').querySelectorAll('input[type="radio"]')

          radios.forEach(radio => {
            if (radio.value === value) {
              radio.setAttribute('checked', true)
            }
          })
        }

        if (input.type === 'checkbox') {
          const checkbox = this.shadow.querySelectorAll(`[name="${key}"]`)

          checkbox.forEach(check => {
            if (value.includes(check.value)) {
              check.checked = true
            }
          })
        }
      }

      if (typeof value === 'object') {
        if (key === 'images') {
          store.dispatch(showImages(value))
        } else if (key === 'locales') {
          Object.entries(value).forEach(([languageAlias, localeValue]) => {
            Object.entries(localeValue).forEach(([name, fieldValue]) => {
              const input = this.shadow.querySelector(`[name="locales\\.${languageAlias}\\.${name}"]`)
              if (input) {
                input.value = fieldValue !== 'null' ? fieldValue : ''

                if (input.tagName === 'SELECT') {
                  const options = input.querySelectorAll('option')
                  options.forEach(option => {
                    if (option.value === fieldValue.toString()) {
                      option.selected = true
                    }
                  })
                  input.dispatchEvent(new Event('change'))
                }
              }
            })
          })
        } else {
          Object.entries(value).forEach(([name, fieldValue]) => {
            const field = this.shadow.querySelector(`[name="${key}.${name}"]`)
            if (field) {
              field.value = fieldValue !== 'null' ? fieldValue : ''
            }
          })
        }
      }
    })

    if (this.shadow.querySelector('.dependants-container')) {
      store.dispatch(setParentElement({ endPoint: this.getAttribute('endpoint'), data: element }))
      this.shadow.querySelector('.dependants-container').classList.add('active')
    }

    if (this.getAttribute('relateds')) {
      this.showRelateds(element)
    }
  }

  showRelateds = element => {
    const relateds = JSON.parse(this.getAttribute('relateds').replaceAll("'", '"'))
    const relatedsContainer = document.createElement('div')
    relatedsContainer.classList.add('relateds-container')
    this.shadow.append(relatedsContainer)

    relateds.forEach(related => {
      const relatedContainer = document.createElement('div')
      relatedContainer.classList.add('related-container')
      relatedsContainer.append(relatedContainer)

      const relatedHeader = document.createElement('div')
      relatedHeader.classList.add('related-header')
      relatedContainer.append(relatedHeader)

      const relatedTitle = document.createElement('span')
      relatedTitle.innerText = related.label
      relatedHeader.append(relatedTitle)

      const relatedsComponents = document.createElement('div')
      relatedsComponents.classList.add('relateds-components')
      relatedContainer.append(relatedsComponents)

      related.structure.forEach(component => {
        if (component.element === 'subform') {
          const formContainer = document.createElement('div')
          formContainer.classList.add('subform-container')

          const formComponent = document.createElement('form-component')
          formComponent.classList.add('dependant')
          formComponent.setAttribute('parent', JSON.stringify(element))
          formComponent.setAttribute('subform', related.name)
          formComponent.setAttribute('endpoint', component.endpoint)
          formComponent.setAttribute('structure', JSON.stringify(component.structure))
          formContainer.append(formComponent)

          relatedsComponents.append(formContainer)
        }

        if (component.element === 'subtable') {
          const tableContainer = document.createElement('div')
          tableContainer.classList.add('subtable-container')

          const tableComponent = document.createElement('table-component')
          tableComponent.classList.add('dependant')
          tableComponent.setAttribute('parent', JSON.stringify(element))
          tableComponent.setAttribute('subtable', related.name)
          tableComponent.setAttribute('endpoint', component.endpoint)
          tableComponent.setAttribute('structure', JSON.stringify(component.structure))
          tableContainer.append(tableComponent)

          relatedsComponents.append(tableContainer)
        }
      })
    })
  }

  validateForm = formInputs => {
    let validForm = true

    const validators = {
      required: {
        regex: /\S/g,
        message: 'El campo es obligatorio'
      },
      onlyLetters: {
        regex: /^[a-zA-Z\s]+$/g,
        message: 'El campo sólo puede contener letras'
      },
      onlyNumbers: {
        regex: /\d/g,
        message: 'El campo sólo puede contener números'
      },
      telephone: {
        regex: /^\d{9}$/g,
        message: 'El campo debe contener 9 números'
      },
      email: {
        regex: /\w+@\w+\.\w+/g,
        message: 'El campo debe contener un email válido'
      },
      password: {
        regex: /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/g,
        message: 'El campo debe contener al menos 8 caracteres, una mayúscula, una minúscula y un número'
      },
      date: {
        regex: /^\d{4}-\d{2}-\d{2}$/g,
        message: 'El campo debe contener una fecha válida'
      },
      time: {
        regex: /^\d{2}:\d{2}$/g,
        message: 'El campo debe contener una hora válida'
      },
      datetime: {
        regex: /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/g,
        message: 'El campo debe contener una fecha y hora válida'
      },
      dni: {
        regex: /^\d{8}[a-zA-Z]$/g,
        message: 'El campo debe contener un DNI válido'
      },
      nif: {
        regex: /^[a-zA-Z]\d{7}[a-zA-Z]$/g,
        message: 'El campo debe contener un NIF válido'
      },
      cif: {
        regex: /^[a-zA-Z]\d{7}[a-zA-Z0-9]$/g,
        message: 'El campo debe contener un CIF válido'
      },
      postalCode: {
        regex: /^\d{5}$/g,
        message: 'El campo debe contener un código postal válido'
      },
      creditCard: {
        regex: /^\d{16}$/g,
        message: 'El campo debe contener una tarjeta de crédito válida'
      },
      iban: {
        regex: /^[a-zA-Z]{2}\d{22}$/g,
        message: 'El campo debe contener un IBAN válido'
      },
      url: {
        regex: /^(http|https):\/\/\w+\.\w+/g,
        message: 'El campo debe contener una URL válida'
      },
      ip: {
        regex: /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/g,
        message: 'El campo debe contener una IP válida'
      },
      mac: {
        regex: /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/g,
        message: 'El campo debe contener una MAC válida'
      },
      image: {
        regex: /\.(gif|jpg|jpeg|tiff|png)$/g,
        message: 'El campo debe contener una imagen válida'
      },
      video: {
        regex: /\.(avi|mp4|mov|wmv|flv|mkv)$/g,
        message: 'El campo debe contener un vídeo válido'
      },
      audio: {
        regex: /\.(mp3|wav|ogg|flac|aac)$/g,
        message: 'El campo debe contener un audio válido'
      },
      pdf: {
        regex: /\.(pdf)$/g,
        message: 'El campo debe contener un PDF válido'
      },
      doc: {
        regex: /\.(doc|docx)$/g,
        message: 'El campo debe contener un documento válido'
      },
      xls: {
        regex: /\.(xls|xlsx)$/g,
        message: 'El campo debe contener una hoja de cálculo válida'
      },
      ppt: {
        regex: /\.(ppt|pptx)$/g,
        message: 'El campo debe contener una presentación válida'
      },
      zip: {
        regex: /\.(zip|rar|7z|tar|gz)$/g,
        message: 'El campo debe contener un archivo comprimido válido'
      }
    }

    for (let i = 0; i < formInputs.length; i++) {
      if (formInputs[i].dataset.validate) {
        formInputs[i].dataset.validate.split(',').forEach((option) => {
          if (formInputs[i].value.match(validators[option].regex) == null) {
            if (!formInputs[i].classList.contains('invalid')) {
              formInputs[i].classList.add('invalid')
              formInputs[i].closest('.form-element').querySelector('label').classList.add('invalid')

              const errorContainer = document.createElement('div')
              const errorMessage = document.createElement('span')
              errorContainer.classList.add('error-container')
              errorMessage.textContent = `${formInputs[i].closest('.form-element').querySelector('label').textContent}: ${validators[option].message}`
              errorContainer.append(errorMessage)

              this.shadow.querySelector('.errors-container').append(errorContainer)
            }

            validForm = false
          } else {
            formInputs[i].classList.remove('invalid')
            formInputs[i].closest('.form-element').querySelector('label').classList.remove('invalid')
          }
        })
      }
    }

    if (!validForm) {
      this.shadow.querySelector('.errors-container').classList.add('active')

      document.dispatchEvent(new CustomEvent('message', {
        detail: {
          message: 'Los datos del formulario no son válidos',
          type: 'error'
        }
      }))
    }

    return validForm
  }
}

customElements.define('form-component', Form)
;</script></head><body><font-loader-component font="Lato:wght@400;700"></font-loader-component><header-component><row-component columns="1"><logo-component title="GameXop"></logo-component></row-component><row-component columns="2"><menu-component></menu-component><user-area-component></user-area-component></row-component></header-component><main-component><delete-element-modal-component></delete-element-modal-component><image-gallery-component></image-gallery-component><message-component></message-component><crud-component><table-filter-component slot="filter" endpoint="/api/admin/users"></table-filter-component><table-component slot="table" endpoint="/api/admin/users" structure="{'headers':[{'label':'Nombre','field':'name'},{'label':'Email','field':'email'},{'label':'Fecha de creación','field':'createdAt'},{'label':'Fecha de actualización','field':'updatedAt'}],'recordButtons':['edit','remove'],'tableButtons':['filterButton']}"></table-component><form-component slot="form" endpoint="/api/admin/users" structure="{'tabs':[{'name':'general','label':'General'},{'name':'images','label':'Imágenes'}],'inputs':{'general':{'noLocale':[{'name':'id','element':'input','type':'hidden'},{'name':'name','element':'input','type':'text','label':'Nombre','width':'half-width'},{'name':'email','element':'input','type':'email','label':'Email','width':'half-width'},{'name':'password','element':'input','type':'password','label':'Contraseña','width':'half-width'},{'name':'password_confirmation','element':'input','type':'password','label':'Confirmar contraseña','width':'half-width'}]},'images':{'noLocale':[{'name':'avatar','element':'input','type':'image','label':'Avatar','width':'half-width','quantity':'single','imageConfigurations':{'thumbnail':{'widthPx':'60','heightPx':'60'},'xs':{'widthPx':'60','heightPx':'60'},'sm':{'widthPx':'60','heightPx':'60'},'md':{'widthPx':'60','heightPx':'60'},'lg':{'widthPx':'60','heightPx':'60'}}}]}}}"></form-component></crud-component></main-component></body></html>